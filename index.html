<!DOCTYPE html>
<html lang="ar" dir="rtl" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ALMASTER | Workspace Login</title>
    <meta name="theme-color" content="#0f172a">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&family=Outfit:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: { primary: { 50: '#f0f9ff', 500: '#0ea5e9', 600: '#0284c7', 700: '#0369a1' }, dark: { 700: '#334155', 800: '#1e293b', 900: '#0f172a', 950: '#020617' } },
                    fontFamily: { sans: ['Outfit', 'Cairo', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        body { background-color: #020617; color: #f1f5f9; overflow: hidden; }
        .bg-pattern {
            background-color: #020617;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Cg fill-rule='evenodd'%3E%3Cg fill='%230ea5e9' fill-opacity='0.05'%3E%3Cpath opacity='.5' d='M96 95h4v1h-4v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9zm-1 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-9-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm9-10v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-9-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm9-10v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-9-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm9-10v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-9-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9z'/%3E%3Cpath d='M6 5V0H5v5H0v1h5v94h1V6h94V5H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        .form-input {
            width: 100%; padding: 14px 16px; padding-left: 45px; border-radius: 14px; border: 2px solid #1e293b;
            font-size: 14px; transition: all 0.3s; background-color: #0f172a; color: white;
        }
        .form-input:focus { border-color: #0ea5e9; box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.15); outline: none; background-color: #1e293b; }
        .input-icon { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: #475569; transition: all 0.3s; }
        .form-input:focus + .input-icon { color: #0ea5e9; }
        .glass-effect { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.05); }
    </style>
</head>

<body class="min-h-screen flex items-center justify-center p-0 md:p-6">

    <div id="global-loader" class="fixed inset-0 z-[200] bg-dark-950 flex flex-col items-center justify-center text-white hidden">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-primary-500 mb-6"></div>
        <h2 id="loader-text" class="text-xl font-bold tracking-widest animate-pulse">جاري تأمين الاتصال...</h2>
    </div>

    <div class="w-full h-screen md:h-auto md:max-w-5xl flex overflow-hidden shadow-2xl rounded-none md:rounded-[2rem] bg-dark-900">
        
        <div class="hidden md:flex md:w-5/12 bg-pattern relative flex-col justify-between p-12 text-white overflow-hidden border-l border-white/5">
            <div class="absolute inset-0 bg-gradient-to-br from-primary-700/40 via-dark-950 to-dark-950 z-0"></div>
            <div class="relative z-10">
                <img src="MASTER_LOGO_WHPNG.png" class="h-12 w-auto mb-10 object-contain" alt="Logo" onerror="this.src='https://ui-avatars.com/api/?background=0ea5e9&color=fff&bold=true&name=AL'">
                <h1 class="text-4xl font-black mb-4 leading-tight italic">Work <br/><span class="text-primary-500 underline decoration-primary-500/30">Smarter</span>.</h1>
                <p class="text-slate-400 font-medium text-lg leading-relaxed">أهلاً بك في نظام الإدارة الذكي الخاص بـ <span class="text-white font-bold">ALMASTER</span>. سيستم متكامل يجمع بين القوة والسهولة.</p>
            </div>
            <div class="relative z-10">
                <div class="flex items-center gap-2 text-xs font-bold text-slate-500 uppercase tracking-widest">
                    <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                    نظام الحماية مفعل
                </div>
            </div>
        </div>

        <div class="w-full md:w-7/12 p-8 md:p-14 flex flex-col justify-center relative">
            
            <div id="login-view" class="animate-fade-in">
                <div class="mb-10 text-right">
                    <h2 class="text-3xl font-black text-white mb-2">تسجيل الدخول</h2>
                    <p class="text-slate-500 text-sm font-bold">ادخل إلى مساحة العمل الخاصة بك.</p>
                </div>

                <form onsubmit="handleLogin(event)" class="space-y-5">
                    <div>
                        <label class="block text-xs font-black text-slate-400 uppercase tracking-widest mb-2 mr-1">البريد الإلكتروني</label>
                        <div class="relative">
                            <input type="email" id="login-email" class="form-input text-left" dir="ltr" placeholder="mohey@almaster.tech" required>
                            <i class="fas fa-at input-icon"></i>
                        </div>
                    </div>

                    <div>
                        <div class="flex justify-between items-center mb-2 px-1">
                            <label class="text-xs font-black text-slate-400 uppercase tracking-widest">كلمة المرور</label>
                            <button type="button" onclick="switchAuthView('reset')" class="text-xs font-bold text-primary-500 hover:text-primary-400 transition">نسيت كلمة المرور؟</button>
                        </div>
                        <div class="relative">
                            <input type="password" id="login-pass" class="form-input text-left font-mono tracking-[0.3em]" dir="ltr" placeholder="••••••••" required>
                            <i class="fas fa-key input-icon"></i>
                        </div>
                    </div>

                    <div id="login-error" class="hidden p-4 rounded-xl bg-red-500/10 border border-red-500/20 flex items-center gap-3 animate-shake">
                        <i class="fas fa-circle-exclamation text-red-500"></i>
                        <p id="error-text" class="text-xs font-bold text-red-400"></p>
                    </div>

                    <button type="submit" id="login-btn" class="w-full py-4 bg-primary-600 hover:bg-primary-500 text-white font-black rounded-2xl shadow-xl shadow-primary-600/20 transition-all transform active:scale-95 flex items-center justify-center gap-3 text-lg mt-8">
                        <span>دخول للمنصة</span>
                        <i class="fas fa-chevron-left text-sm mt-1"></i>
                    </button>
                </form>
            </div>

            <div id="reset-view" class="hidden animate-fade-in">
                <button onclick="switchAuthView('login')" class="mb-8 text-slate-400 hover:text-white transition flex items-center gap-2 font-bold text-sm">
                    <i class="fas fa-arrow-right mt-1"></i> العودة لتسجيل الدخول
                </button>
                <div class="mb-8 text-right">
                    <h2 class="text-3xl font-black text-white mb-2">استعادة الحساب</h2>
                    <p class="text-slate-500 text-sm font-bold">سنقوم بإرسال رابط إعادة تعيين كلمة المرور لبريدك.</p>
                </div>

                <form onsubmit="handlePasswordReset(event)" class="space-y-6">
                    <div>
                        <label class="block text-xs font-black text-slate-400 uppercase tracking-widest mb-2 mr-1">بريدك الإلكتروني المسجل</label>
                        <div class="relative">
                            <input type="email" id="reset-email" class="form-input text-left" dir="ltr" placeholder="name@almaster.tech" required>
                            <i class="fas fa-paper-plane input-icon"></i>
                        </div>
                    </div>

                    <div id="reset-msg" class="hidden p-4 rounded-xl flex items-center gap-3">
                        <i id="reset-icon" class="fas"></i>
                        <p id="reset-text" class="text-xs font-bold"></p>
                    </div>

                    <button type="submit" id="reset-btn" class="w-full py-4 bg-slate-100 hover:bg-white text-dark-950 font-black rounded-2xl transition-all transform active:scale-95 flex items-center justify-center gap-3 text-lg">
                        <span>إرسال رابط الاستعادة</span>
                    </button>
                </form>
            </div>

        </div>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyCXyuT529aGwiS5j_RPxW_zEeAtkYc7JlM", authDomain: "almaster-b8c18.firebaseapp.com", projectId: "almaster-b8c18", storageBucket: "almaster-b8c18.firebasestorage.app", messagingSenderId: "884142036232", appId: "1:884142036232:web:eeb6677d988565653a08bd" };
        if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
        const db = firebase.firestore();
        const auth = firebase.auth();

        function toggleLoader(show, text = "جاري التحقق...") {
            const loader = document.getElementById('global-loader');
            const loaderText = document.getElementById('loader-text');
            if (show) { loaderText.innerText = text; loader.classList.remove('hidden'); } 
            else { loader.classList.add('hidden'); }
        }

        // التبديل بين شاشة اللوجن والـ Reset
        function switchAuthView(view) {
            const loginV = document.getElementById('login-view');
            const resetV = document.getElementById('reset-view');
            if(view === 'reset') { loginV.classList.add('hidden'); resetV.classList.remove('hidden'); }
            else { resetV.classList.add('hidden'); loginV.classList.remove('hidden'); }
        }

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                toggleLoader(true, `جاري توجيهك لمساحة العمل...`);
                await redirectUserBasedOnRole(user.email);
            }
        });

        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value.toLowerCase().trim();
            const pass = document.getElementById('login-pass').value;
            const btn = document.getElementById('login-btn');
            const errorBox = document.getElementById('login-error');
            
            errorBox.classList.add('hidden');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-circle-notch fa-spin text-2xl"></i>';

            try {
                await auth.signInWithEmailAndPassword(email, pass);
                const newSessionId = Date.now() + "_" + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('my_session_id', newSessionId);
                await db.collection('users').doc(email).update({ sessionId: newSessionId }, { merge: true });
                await redirectUserBasedOnRole(email);
            } catch (err) {
                btn.disabled = false;
                btn.innerHTML = '<span>دخول للمنصة</span><i class="fas fa-chevron-left text-sm mt-1"></i>';
                document.getElementById('error-text').innerText = "فشل الدخول: البريد أو كلمة المرور غير صحيحة.";
                errorBox.classList.remove('hidden');
            }
        }

        async function handlePasswordReset(e) {
            e.preventDefault();
            const email = document.getElementById('reset-email').value.trim();
            const btn = document.getElementById('reset-btn');
            const msgBox = document.getElementById('reset-msg');
            const msgText = document.getElementById('reset-text');
            const msgIcon = document.getElementById('reset-icon');

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i>';

            try {
                await auth.sendPasswordResetEmail(email);
                msgBox.className = "p-4 rounded-xl bg-green-500/10 border border-green-500/20 flex items-center gap-3 mt-4";
                msgIcon.className = "fas fa-check-circle text-green-500 text-xl";
                msgText.innerText = "تم إرسال الرابط! تفقد بريدك الإلكتروني (بما في ذلك السبام).";
                msgBox.classList.remove('hidden');
                btn.innerHTML = "تم الإرسال بنجاح ✅";
            } catch (err) {
                btn.disabled = false;
                btn.innerText = "إرسال رابط الاستعادة";
                msgBox.className = "p-4 rounded-xl bg-red-500/10 border border-red-500/20 flex items-center gap-3 mt-4";
                msgIcon.className = "fas fa-exclamation-triangle text-red-500 text-xl";
                msgText.innerText = "خطأ: تأكد من كتابة البريد بشكل صحيح.";
                msgBox.classList.remove('hidden');
            }
        }

        async function redirectUserBasedOnRole(email) {
            try {
                const userDoc = await db.collection('users').doc(email.toLowerCase()).get();
                if (!userDoc.exists) throw new Error("User Not Found");
                
                const role = userDoc.data().role || 'employee';
                const pages = { 'admin': 'admin.html', 'supervisor': 'supervisor.html', 'leader': 'leader.html', 'employee': 'employee.html' };
                
                window.location.replace(pages[role] || 'employee.html');
            } catch (error) {
                toggleLoader(false);
                auth.signOut();
                alert("خطأ في صلاحيات الحساب. يرجى مراجعة الإدارة.");
            }
        }
    </script>
</body>
</html>
