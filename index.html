<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ | ALMASTER WORKSPACE</title>
    <meta name="theme-color" content="#0ea5e9">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&family=Outfit:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: { primary: { 50: '#f0f9ff', 100: '#e0f2fe', 500: '#0ea5e9', 600: '#0284c7', 700: '#0369a1', 900: '#0c4a6e' }, dark: { 800: '#1e293b', 900: '#0f172a' } },
                    fontFamily: { sans: ['Outfit', 'Cairo', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Outfit', 'Cairo', sans-serif; }
        .bg-pattern {
            background-color: #0f172a;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Cg fill-rule='evenodd'%3E%3Cg fill='%230ea5e9' fill-opacity='0.1'%3E%3Cpath opacity='.5' d='M96 95h4v1h-4v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9zm-1 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-9-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm9-10v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-9-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm9-10v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-9-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm9-10v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-9-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9z'/%3E%3Cpath d='M6 5V0H5v5H0v1h5v94h1V6h94V5H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        .form-input {
            width: 100%; padding: 12px 16px; padding-left: 40px; border-radius: 12px; border: 2px solid #e2e8f0;
            font-size: 14px; transition: all 0.3s; background-color: #f8fafc;
        }
        .form-input:focus { border-color: #0ea5e9; box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.1); outline: none; background-color: white; }
        .input-icon { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: #94a3b8; transition: all 0.3s; }
        .form-input:focus + .input-icon { color: #0ea5e9; }
    </style>
</head>

<body class="min-h-screen flex items-center justify-center bg-slate-100 dark:bg-slate-900">

    <div id="global-loader" class="fixed inset-0 z-50 bg-slate-900/90 backdrop-blur-sm flex flex-col items-center justify-center text-white hidden">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-primary-500 mb-6"></div>
        <h2 id="loader-text" class="text-xl font-bold tracking-widest animate-pulse">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</h2>
    </div>

    <div class="w-full h-screen flex overflow-hidden shadow-2xl rounded-none md:rounded-3xl md:h-auto md:max-w-5xl md:m-8 bg-white dark:bg-slate-800">
        
        <div class="hidden md:flex md:w-1/2 bg-pattern relative flex-col justify-between p-12 text-white overflow-hidden">
            <div class="absolute inset-0 bg-gradient-to-br from-primary-600/90 to-slate-900/90 z-0"></div>
            <div class="relative z-10">
                <div class="flex items-center gap-3 mb-8">
                    <img src="MASTER_LOGO_WHPNG.png" class="h-12 w-auto object-contain" alt="Logo" onerror="this.src='https://ui-avatars.com/api/?background=ffffff&color=0284c7&bold=true&name=AL'">
                </div>
                <h1 class="text-4xl font-black mb-4 leading-tight">Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ <br/> Ø¨ÙŠØ¦Ø© Ø¹Ù…Ù„ Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„.</h1>
                <p class="text-lg text-primary-100 opacity-90 font-medium">Ù†Ø¸Ø§Ù… Ù…ØªÙƒØ§Ù…Ù„ Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù‡Ø§Ù…ØŒ Ø§Ù„ÙØ±Ù‚ØŒ ÙˆØ§Ù„Ù…Ø§Ù„ÙŠØ§Øª Ø¨ÙƒÙØ§Ø¡Ø© ÙˆØ§Ø­ØªØ±Ø§ÙÙŠØ©.</p>
            </div>
            <div class="relative z-10">
                <div class="flex items-center gap-2 text-sm text-primary-200">
                    <i class="fas fa-shield-alt"></i>
                    <span>Ø§ØªØµØ§Ù„ Ø¢Ù…Ù† ÙˆÙ…Ø­Ù…ÙŠ 100%</span>
                </div>
                <p class="text-xs mt-4 opacity-50">Â© 2024 ALMASTER. All rights reserved.</p>
            </div>
            <div class="absolute -bottom-24 -right-24 w-64 h-64 bg-primary-500 rounded-full filter blur-3xl opacity-20 z-0 animate-pulse"></div>
            <div class="absolute top-1/4 -left-24 w-48 h-48 bg-blue-400 rounded-full filter blur-3xl opacity-10 z-0"></div>
        </div>

        <div class="w-full md:w-1/2 p-8 md:p-12 flex flex-col justify-center bg-white dark:bg-slate-800">
            <div class="text-center md:text-right mb-10">
                <img src="MASTER_LOGO_WHPNG.png" class="h-14 mx-auto md:mx-0 mb-6 md:hidden object-contain" alt="Logo" onerror="this.src='https://ui-avatars.com/api/?background=0ea5e9&color=fff&bold=true&name=AL'">
                <h2 class="text-3xl font-black text-slate-800 dark:text-white mb-2">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
                <p class="text-slate-500 dark:text-slate-400 text-sm font-bold">ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ø¹ØªÙ…Ø§Ø¯Ùƒ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø¥Ù„Ù‰ Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¹Ù…Ù„.</p>
            </div>

            <form onsubmit="handleLogin(event)" class="space-y-6">
                <div>
                    <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2" for="login-email">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                    <div class="relative">
                        <input type="email" id="login-email" class="form-input text-left" dir="ltr" placeholder="name@company.com" required>
                        <i class="fas fa-envelope input-icon"></i>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2" for="login-pass">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                    <div class="relative">
                        <input type="password" id="login-pass" class="form-input text-left font-mono tracking-widest" dir="ltr" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required>
                        <i class="fas fa-lock input-icon"></i>
                    </div>
                </div>

                <div id="login-error" class="hidden p-4 rounded-xl bg-red-50 dark:bg-red-900/20 border-2 border-red-100 dark:border-red-800/30 flex items-center gap-3 animate-fade-in">
                    <i class="fas fa-exclamation-circle text-red-500 text-xl"></i>
                    <p id="error-text" class="text-sm font-bold text-red-600 dark:text-red-400"></p>
                </div>

                <button type="submit" id="login-btn" class="w-full py-4 bg-primary-600 hover:bg-primary-700 text-white font-black rounded-xl shadow-lg shadow-primary-500/30 transition-all transform hover:scale-[1.01] hover:shadow-xl flex items-center justify-center gap-3 text-lg">
                    <span>Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù†Ø¸Ø§Ù…</span>
                    <i class="fas fa-arrow-left mt-1"></i>
                </button>
            </form>
        </div>
    </div>

    <script>
        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase
        const firebaseConfig = { apiKey: "AIzaSyCXyuT529aGwiS5j_RPxW_zEeAtkYc7JlM", authDomain: "almaster-b8c18.firebaseapp.com", projectId: "almaster-b8c18", storageBucket: "almaster-b8c18.firebasestorage.app", messagingSenderId: "884142036232", appId: "1:884142036232:web:eeb6677d988565653a08bd" };
        if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Ø¯Ø§Ù„Ø© Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù„ÙˆØ¯Ø±
        function toggleLoader(show, text = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...") {
            const loader = document.getElementById('global-loader');
            const loaderText = document.getElementById('loader-text');
            if (show) {
                loaderText.innerText = text;
                loader.classList.remove('hidden');
            } else {
                loader.classList.add('hidden');
            }
        }

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„ÙØ¹Ù„ØŒ Ù†Ù‚ÙˆÙ… Ø¨ØªÙˆØ¬ÙŠÙ‡Ù‡ Ù…Ø¨Ø§Ø´Ø±Ø©
                toggleLoader(true, `Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ø¹ÙˆØ¯ØªÙƒ! Ø¬Ø§Ø±ÙŠ ØªÙˆØ¬ÙŠÙ‡Ùƒ...`);
                await redirectUserBasedOnRole(user.email);
            }
        });

        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value.toLowerCase().trim();
            const pass = document.getElementById('login-pass').value;
            const btn = document.getElementById('login-btn');
            const errorBox = document.getElementById('login-error');
            
            errorBox.classList.add('hidden');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin animate-spin text-2xl"></i>';
            toggleLoader(true, "Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...");

            try {
                // 1. Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                await auth.signInWithEmailAndPassword(email, pass);
                
                // 2. ØªØ³Ø¬ÙŠÙ„ Ø¬Ù„Ø³Ø© Ø¬Ø¯ÙŠØ¯Ø© (Ù„Ù„Ø­Ù…Ø§ÙŠØ© Ù…Ù† Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…ØªÙƒØ±Ø±)
                const newSessionId = Date.now() + "_" + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('my_session_id', newSessionId);
                await db.collection('users').doc(email).update({ sessionId: newSessionId }, { merge: true });
                
                // 3. Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø±ØªØ¨Ø©
                toggleLoader(true, "ØªÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­! Ø¬Ø§Ø±ÙŠ ØªØ­ÙˆÙŠÙ„Ùƒ Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¹Ù…Ù„...");
                await redirectUserBasedOnRole(email);

            } catch (err) {
                console.error("Login Error:", err);
                toggleLoader(false);
                btn.disabled = false;
                btn.innerHTML = '<span>Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù†Ø¸Ø§Ù…</span><i class="fas fa-arrow-left mt-1"></i>';
                
                let errorMsg = "Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.";
                if (err.code === 'auth/user-not-found' || err.code === 'auth/wrong-password') errorMsg = "Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.";
                if (err.code === 'auth/too-many-requests') errorMsg = "ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ø¤Ù‚ØªØ§Ù‹ Ø¨Ø³Ø¨Ø¨ ØªÙƒØ±Ø§Ø± Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø§Ù„ÙØ§Ø´Ù„Ø©. Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ø§Ù‹.";
                
                document.getElementById('error-text').innerText = errorMsg;
                errorBox.classList.remove('hidden');
            }
        }

        // ğŸŸ¢ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø¬ÙˆÙ‡Ø±ÙŠØ©: Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø­Ø³Ø¨ Ø§Ù„Ø±ØªØ¨Ø© ğŸŸ¢
        async function redirectUserBasedOnRole(email) {
            try {
                const userDoc = await db.collection('users').doc(email.toLowerCase()).get();
                if (!userDoc.exists) {
                    throw new Error("Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù….");
                }
                
                const userData = userDoc.data();
                const role = userData.role || 'employee'; // Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù…ÙˆØ¸Ù
                
                let targetPage = 'employee.html'; // Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©

                switch (role) {
                    case 'admin':
                        targetPage = 'admin.html';
                        break;
                    case 'supervisor':
                        targetPage = 'supervisor.html';
                        break;
                    case 'leader':
                        targetPage = 'leader.html';
                        break;
                    // case 'employee' ØªØ¸Ù„ ÙƒÙ…Ø§ Ù‡ÙŠ
                }
                
                // ØªÙ†ÙÙŠØ° Ø§Ù„ØªØ­ÙˆÙŠÙ„
                window.location.replace(targetPage);

            } catch (error) {
                console.error("Redirect Error:", error);
                toggleLoader(false);
                auth.signOut();
                document.getElementById('error-text').innerText = "Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ ØµÙ„Ø§Ø­ÙŠØ§ØªÙƒ. ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©.";
                document.getElementById('login-error').classList.remove('hidden');
                document.getElementById('login-btn').disabled = false;
                document.getElementById('login-btn').innerHTML = '<span>Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù†Ø¸Ø§Ù…</span><i class="fas fa-arrow-left mt-1"></i>';
            }
        }
    </script>
</body>
</html>
