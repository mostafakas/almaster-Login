<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Almaster Pro V14 - Analytics & Tasks</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Outfit:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <style>
        :root { --primary: #0ea5e9; }
        body { background-color: #f8fafc; font-family: 'Outfit', 'Cairo', sans-serif; }
        .dark-mode { background-color: #0f172a; color: white; }
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        .hidden-section { display: none !important; }
        .stat-card { border-radius: 1rem; padding: 1.5rem; background: white; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        .task-urgent { border-left: 4px solid #ef4444; }
        .task-normal { border-left: 4px solid #3b82f6; }
    </style>
</head>

<body class="min-h-screen text-slate-800 selection:bg-primary-500 selection:text-white">

    <div id="loader" class="fixed inset-0 z-[200] bg-slate-900 flex flex-col items-center justify-center text-white">
        <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-sky-500 mb-4"></div>
        <h2 class="text-lg font-bold tracking-widest animate-pulse">ALMASTER PRO V14</h2>
    </div>

    <div id="view-login" class="hidden-section min-h-screen flex items-center justify-center p-4 bg-slate-100">
        <div class="w-full max-w-sm glass p-8 rounded-2xl shadow-2xl border border-white">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-sky-700 mb-1">ALMASTER</h1>
                <p class="text-xs text-slate-500 uppercase font-bold tracking-tighter">Enterprise Analytics</p>
            </div>
            <form onsubmit="handleLogin(event)">
                <input type="email" id="login-email" placeholder="Email" class="w-full p-3 rounded-lg border mb-4 outline-none focus:ring-2 ring-sky-500" required>
                <input type="password" id="login-pass" placeholder="Password" class="w-full p-3 rounded-lg border mb-6 outline-none focus:ring-2 ring-sky-500" required>
                <button type="submit" class="w-full bg-sky-600 text-white font-bold py-3 rounded-lg hover:bg-sky-700 transition">Enter System</button>
            </form>
        </div>
    </div>

    <div id="view-system" class="hidden-section flex min-h-screen">
        
        <aside class="w-20 md:w-64 bg-slate-900 text-white flex flex-col transition-all">
            <div class="p-6 text-xl font-bold border-b border-slate-800 text-sky-400">ALMASTER</div>
            <nav class="flex-1 p-4 space-y-2">
                <button onclick="showSection('dashboard')" class="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-slate-800 transition">
                    <i class="fas fa-chart-line"></i> <span class="hidden md:block">Dashboard</span>
                </button>
                <div id="admin-only-nav" class="hidden">
                    <button onclick="showSection('analytics')" class="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-slate-800 transition text-yellow-400">
                        <i class="fas fa-brain"></i> <span class="hidden md:block">Team Analytics</span>
                    </button>
                </div>
            </nav>
            <button onclick="logout()" class="p-6 text-red-400 border-t border-slate-800 hover:bg-red-900/20 flex items-center gap-3">
                <i class="fas fa-power-off"></i> <span class="hidden md:block">Logout</span>
            </button>
        </aside>

        <main class="flex-1 flex flex-col overflow-hidden">
            <header class="h-16 bg-white border-b flex items-center justify-between px-8">
                <div id="header-title" class="text-lg font-bold">Team Overview</div>
                <div class="flex items-center gap-4">
                    <div id="user-info" class="text-right hidden md:block">
                        <p id="user-name" class="text-sm font-bold">Loading...</p>
                        <p id="user-role" class="text-[10px] uppercase text-slate-400 font-bold tracking-widest"></p>
                    </div>
                </div>
            </header>

            <div class="flex-1 overflow-auto p-6 bg-slate-50">
                
                <section id="sec-dashboard" class="space-y-6">
                    <div id="grid-users" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6"></div>
                </section>

                <section id="sec-analytics" class="hidden-section space-y-6">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="stat-card bg-gradient-to-br from-sky-600 to-sky-700 text-white">
                            <p class="text-xs font-bold uppercase opacity-80">Mean Productivity (Online)</p>
                            <h2 id="ana-mean" class="text-3xl font-bold mt-2">00:00:00</h2>
                            <p class="text-[10px] mt-2 italic">$\bar{x}$ based on current team data</p>
                        </div>
                        <div class="stat-card bg-white border-l-4 border-yellow-500">
                            <p class="text-xs font-bold text-slate-500 uppercase">Coeff. of Variation (CV)</p>
                            <h2 id="ana-cv" class="text-3xl font-bold mt-2 text-slate-800">0%</h2>
                            <p id="cv-desc" class="text-[10px] mt-2 font-bold text-slate-400">Stable Performance</p>
                        </div>
                        <div class="stat-card bg-white border-l-4 border-red-500">
                            <p class="text-xs font-bold text-slate-500 uppercase">Idle Std. Deviation ($\sigma$)</p>
                            <h2 id="ana-std" class="text-3xl font-bold mt-2 text-red-600">0.0</h2>
                            <p class="text-[10px] mt-2 font-bold text-slate-400 text-red-400">Variance in break patterns</p>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <h3 class="font-bold mb-4">Work Distribution (Team % Comparison)</h3>
                        <div class="h-64"><canvas id="teamChart"></canvas></div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <div id="toast-container" class="fixed bottom-5 left-5 z-[300] space-y-2"></div>

    <script>
        // --- 1. CONFIG & INIT ---
        const firebaseConfig = {
            apiKey: "AIzaSyCXyuT529aGwiS5j_RPxW_zEeAtkYc7JlM",
            authDomain: "almaster-b8c18.firebaseapp.com",
            projectId: "almaster-b8c18",
            storageBucket: "almaster-b8c18.firebasestorage.app",
            messagingSenderId: "884142036232",
            appId: "1:884142036232:web:eeb6677d988565653a08bd"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        let currentUser = null;
        let userData = null;
        let allUsers = [];
        let teamChart = null;

        // --- 2. AUTH LOGIC ---
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                const doc = await db.collection('users').doc(user.email.toLowerCase()).get();
                if (doc.exists) {
                    userData = doc.data();
                    updateUI();
                    startListeners();
                } else { auth.signOut(); }
            } else {
                showView('login');
            }
        });

        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-pass').value;
            try { await auth.signInWithEmailAndPassword(email, pass); }
            catch (err) { alert(err.message); }
        }

        function logout() { 
            if(currentUser) db.collection('users').doc(currentUser.email).update({ status: 'Offline' });
            auth.signOut().then(() => location.reload()); 
        }

        // --- 3. CORE LOGIC & LISTENERS ---
        function startListeners() {
            db.collection('users').onSnapshot(snap => {
                allUsers = [];
                snap.forEach(doc => allUsers.push(doc.data()));
                renderDashboard();
                if(userData.role === 'admin') {
                    document.getElementById('admin-only-nav').classList.remove('hidden');
                    calculateAdvancedAnalytics();
                }
                document.getElementById('loader').classList.add('hidden-section');
            });
        }

        function renderDashboard() {
            const grid = document.getElementById('grid-users');
            grid.innerHTML = '';
            allUsers.forEach(u => {
                const isMe = u.email === currentUser.email;
                const onlineMs = (u.timeBank?.Online || 0);
                const idleMs = (u.idleBank || 0);
                
                const card = `
                    <div class="stat-card relative border-t-4 ${getStatusBorder(u.status)}">
                        <div class="flex items-center gap-4 mb-4">
                            <img src="${u.photo || 'https://ui-avatars.com/api/?name='+u.name}" class="w-12 h-12 rounded-full border">
                            <div>
                                <h3 class="font-bold text-slate-800">${u.name} ${isMe ? '(You)' : ''}</h3>
                                <p class="text-[10px] font-bold text-slate-400 uppercase">${u.status}</p>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-2 text-center mb-4">
                            <div class="bg-sky-50 p-2 rounded-lg">
                                <p class="text-[8px] uppercase font-bold text-sky-600">Working Time</p>
                                <p class="font-mono font-bold">${formatTime(onlineMs)}</p>
                            </div>
                            <div class="bg-red-50 p-2 rounded-lg">
                                <p class="text-[8px] uppercase font-bold text-red-600">Idle Time</p>
                                <p class="font-mono font-bold">${formatTime(idleMs)}</p>
                            </div>
                        </div>

                        <div class="space-y-2 mb-4">
                            <p class="text-[9px] font-bold uppercase text-slate-400">Active Tasks</p>
                            ${(u.tasks || []).map((t, idx) => `
                                <div class="p-2 bg-slate-50 rounded border-l-4 ${t.priority === 'high' ? 'border-red-500' : 'border-blue-500'} text-xs flex justify-between items-center">
                                    <span>${t.text}</span>
                                    ${isMe ? `<button onclick="toggleTaskTimer('${idx}')" class="text-sky-600 font-bold"><i class="fas fa-play-circle"></i></button>` : ''}
                                </div>
                            `).join('')}
                        </div>

                        ${(isMe || userData.role === 'admin') ? `
                            <div class="flex gap-1">
                                <button onclick="setStatus('${u.email}', 'Online')" class="flex-1 text-[8px] font-bold p-1 bg-green-50 text-green-600 border border-green-200 rounded">ONLINE</button>
                                <button onclick="setStatus('${u.email}', 'Break')" class="flex-1 text-[8px] font-bold p-1 bg-yellow-50 text-yellow-600 border border-yellow-200 rounded">BREAK</button>
                                <button onclick="setStatus('${u.email}', 'Offline')" class="flex-1 text-[8px] font-bold p-1 bg-slate-50 text-slate-600 border border-slate-200 rounded">OFFLINE</button>
                            </div>
                        ` : ''}
                    </div>
                `;
                grid.innerHTML += card;
            });
        }

        // --- 4. ADVANCED ANALYTICS (STATISTICS) ---
        function calculateAdvancedAnalytics() {
            const onlineTimes = allUsers.map(u => u.timeBank?.Online || 0);
            const idleTimes = allUsers.map(u => u.idleBank || 0);
            const n = onlineTimes.length;

            if (n === 0) return;

            // 1. Mean (المتوسط الحسابي)
            const meanOnline = onlineTimes.reduce((a, b) => a + b, 0) / n;
            document.getElementById('ana-mean').innerText = formatTime(meanOnline);

            // 2. Std Deviation (الانحراف المعياري)
            const variance = onlineTimes.reduce((a, b) => a + Math.pow(b - meanOnline, 2), 0) / (n - 1 || 1);
            const stdDev = Math.sqrt(variance);

            // 3. Coefficient of Variation (معامل الاختلاف CV)
            const cv = meanOnline > 0 ? (stdDev / meanOnline) * 100 : 0;
            document.getElementById('ana-cv').innerText = cv.toFixed(1) + '%';
            
            const cvDesc = document.getElementById('cv-desc');
            if (cv > 30) {
                cvDesc.innerText = "High Disparity - Check Workload!";
                cvDesc.className = "text-[10px] mt-2 font-bold text-red-500";
            } else {
                cvDesc.innerText = "Performance is Balanced";
                cvDesc.className = "text-[10px] mt-2 font-bold text-green-500";
            }

            // 4. Idle Analysis
            const meanIdle = idleTimes.reduce((a, b) => a + b, 0) / n;
            const idleVariance = idleTimes.reduce((a, b) => a + Math.pow(b - meanIdle, 2), 0) / (n - 1 || 1);
            document.getElementById('ana-std').innerText = (Math.sqrt(idleVariance) / 60000).toFixed(1) + "m";

            updateChart(allUsers);
        }

        // --- 5. CHARTING ---
        function updateChart(users) {
            const ctx = document.getElementById('teamChart').getContext('2d');
            const labels = users.map(u => u.name);
            const onlineData = users.map(u => (u.timeBank?.Online || 0) / 3600000); // Convert to hours
            
            if (teamChart) teamChart.destroy();
            
            teamChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Working Hours (Online)',
                        data: onlineData,
                        backgroundColor: '#0ea5e9'
                    }]
                },
                options: { maintainAspectRatio: false }
            });
        }

        // --- HELPERS ---
        function getStatusBorder(s) {
            if(s === 'Online') return 'border-green-500';
            if(s === 'Break') return 'border-yellow-500';
            return 'border-slate-300';
        }

        function formatTime(ms) {
            const h = Math.floor(ms / 3600000).toString().padStart(2, '0');
            const m = Math.floor((ms % 3600000) / 60000).toString().padStart(2, '0');
            const s = Math.floor((ms % 60000) / 1000).toString().padStart(2, '0');
            return `${h}:${m}:${s}`;
        }

        function showSection(sec) {
            document.getElementById('sec-dashboard').classList.add('hidden-section');
            document.getElementById('sec-analytics').classList.add('hidden-section');
            document.getElementById('sec-' + sec).classList.remove('hidden-section');
            document.getElementById('header-title').innerText = sec.toUpperCase();
        }

        function showView(v) {
            document.getElementById('view-login').classList.add('hidden-section');
            document.getElementById('view-system').classList.add('hidden-section');
            document.getElementById('view-' + v).classList.remove('hidden-section');
        }

        function updateUI() {
            showView('system');
            document.getElementById('user-name').innerText = userData.name;
            document.getElementById('user-role').innerText = userData.role;
        }

        async function setStatus(email, status) {
            await db.collection('users').doc(email).update({ status: status, lastChange: firebase.firestore.FieldValue.serverTimestamp() });
        }

        // --- IDLE TRACKER ENHANCED ---
        let lastMove = Date.now();
        window.onmousemove = () => { lastMove = Date.now(); };
        setInterval(() => {
            if(userData && userData.status === 'Online' && (Date.now() - lastMove > 15 * 60 * 1000)) {
                // Logic for 15 min Idle
                console.log("User Idle for 15+ mins");
                // Here we can trigger a notification via FCM or Toast
            }
        }, 30000);

    </script>
</body>
</html>
