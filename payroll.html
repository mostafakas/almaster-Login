<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ALMASTER | النظام المالي المتكامل</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        body { font-family: 'Cairo', sans-serif; background-color: #f1f5f9; }
        .table-container { height: calc(100vh - 350px); overflow-y: auto; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #64748b; border-radius: 10px; }
        .card-stat { transition: all 0.3s ease; }
        .card-stat:hover { transform: translateY(-3px); }
    </style>
</head>
<body class="text-slate-800">

    <div id="payroll-loader" class="fixed inset-0 z-[200] bg-slate-900 flex flex-col items-center justify-center text-white">
        <div class="w-12 h-12 border-4 border-emerald-500 border-t-transparent rounded-full animate-spin mb-4"></div>
        <p class="font-bold tracking-widest animate-pulse">ALMASTER FINANCIAL SYSTEM</p>
    </div>

    <header class="bg-white shadow-md h-20 px-6 flex items-center justify-between sticky top-0 z-50">
        <div class="flex items-center gap-4">
            <div class="bg-slate-900 w-12 h-12 rounded-2xl flex items-center justify-center text-white shadow-lg">
                <i class="fas fa-vault text-xl text-emerald-400"></i>
            </div>
            <div>
                <h1 class="text-xl font-black text-slate-900 tracking-tight">ALMASTER FINANCE</h1>
                <div class="flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
                    <p class="text-[10px] text-slate-500 font-bold uppercase tracking-widest">إدارة الخزنة والرواتب</p>
                </div>
            </div>
        </div>
        
        <div class="flex items-center gap-4">
            <div class="flex flex-col text-left">
                <label class="text-[9px] font-black text-slate-400 mr-2">اختر الشهر الضريبي</label>
                <select id="month-picker" onchange="changeMonth()" class="bg-slate-100 border-none rounded-xl px-4 py-1.5 text-xs font-bold focus:ring-2 ring-emerald-500 cursor-pointer"></select>
            </div>
            <button onclick="exportToExcel()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-xl text-xs font-bold flex items-center gap-2 transition shadow-lg shadow-emerald-500/20">
                <i class="fas fa-file-export"></i> تصدير التقرير
            </button>
            <button onclick="window.location.href='index.html'" class="w-10 h-10 flex items-center justify-center rounded-xl bg-slate-100 text-slate-500 hover:bg-slate-900 hover:text-white transition">
                <i class="fas fa-home"></i>
            </button>
        </div>
    </header>

    <main class="p-4 md:p-6 max-w-[1600px] mx-auto">
        
        <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
            <div class="bg-slate-900 p-5 rounded-3xl shadow-xl text-white card-stat relative overflow-hidden">
                <i class="fas fa-wallet absolute -right-4 -bottom-4 text-6xl opacity-10"></i>
                <p class="text-[10px] font-bold text-emerald-400 uppercase mb-1">رصيد الخزنة المتاح</p>
                <div class="flex items-baseline gap-2">
                    <h3 id="vault-balance" class="text-2xl font-black">0</h3>
                    <span class="text-[10px] font-bold opacity-60">EGP</span>
                </div>
                <button onclick="openVaultModal()" class="mt-3 text-[9px] font-bold bg-white/10 hover:bg-white/20 px-3 py-1 rounded-full transition">تعديل الرصيد</button>
            </div>

            <div class="bg-white p-5 rounded-3xl shadow-sm border border-slate-200 card-stat">
                <p class="text-[10px] font-bold text-slate-400 uppercase mb-1">إجمالي المرتبات (الصافي)</p>
                <h3 id="total-net-salaries" class="text-xl font-black text-slate-800">0</h3>
                <p class="text-[9px] text-slate-400 mt-1">المستحق للموظفين هذا الشهر</p>
            </div>

            <div class="bg-white p-5 rounded-3xl shadow-sm border border-slate-200 card-stat">
                <p class="text-[10px] font-bold text-slate-400 uppercase mb-1">مصروفات ونثريات</p>
                <div class="flex items-center justify-between">
                    <h3 id="total-expenses" class="text-xl font-black text-red-500">0</h3>
                    <button onclick="openExpenseModal()" class="w-7 h-7 bg-red-50 text-red-500 rounded-lg flex items-center justify-center hover:bg-red-500 hover:text-white transition"><i class="fas fa-plus text-[10px]"></i></button>
                </div>
                <p class="text-[9px] text-slate-400 mt-1">مصاريف جانبية للمكتب</p>
            </div>

            <div class="bg-emerald-500 p-5 rounded-3xl shadow-lg text-white card-stat">
                <p class="text-[10px] font-bold opacity-80 uppercase mb-1">صافي المنصرف فعلياً ✅</p>
                <h3 id="total-spent" class="text-xl font-black">0</h3>
                <p class="text-[9px] opacity-80 mt-1">مرتبات محولة + نثريات</p>
            </div>

            <div class="bg-white p-5 rounded-3xl shadow-sm border border-slate-200 card-stat text-center">
                <p class="text-[10px] font-bold text-slate-400 uppercase mb-1">المتبقي في الخزنة</p>
                <h3 id="remaining-vault" class="text-xl font-black text-blue-600">0</h3>
                <p class="text-[9px] text-slate-400 mt-1">بعد خصم كل المنصرف</p>
            </div>
        </div>

        <div class="flex gap-6">
            <div class="flex-[3] bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="p-4 border-b flex justify-between items-center bg-slate-50/50">
                    <h4 class="font-black text-sm flex items-center gap-2"><i class="fas fa-users text-emerald-500"></i> كشف رواتب الموظفين</h4>
                    <input type="text" id="search-input" oninput="renderPayroll()" placeholder="بحث سريع..." class="bg-white border-slate-200 rounded-lg px-3 py-1 text-[10px] w-40 focus:ring-1 ring-emerald-500">
                </div>
                <div class="overflow-x-auto table-container">
                    <table class="w-full text-right border-collapse text-[11px]">
                        <thead class="bg-white sticky top-0 shadow-sm">
                            <tr class="text-slate-400 font-black uppercase border-b border-slate-100">
                                <th class="p-4">الموظف</th>
                                <th class="p-4">الأساسي</th>
                                <th class="p-4 text-green-600">مكافآت</th>
                                <th class="p-4 text-blue-600">حوافز</th>
                                <th class="p-4 text-red-500">خصومات</th>
                                <th class="p-4 font-black text-slate-900 bg-slate-50/50">الصافي</th>
                                <th class="p-4">بيانات الدفع</th>
                                <th class="p-4">الحالة</th>
                                <th class="p-4 text-center">تعديل</th>
                            </tr>
                        </thead>
                        <tbody id="payroll-body" class="divide-y divide-slate-50"></tbody>
                    </table>
                </div>
            </div>

            <div class="flex-1 bg-white rounded-3xl shadow-sm border border-slate-200 flex flex-col max-h-[calc(100vh-280px)]">
                <div class="p-4 border-b bg-red-50/30 flex justify-between items-center">
                    <h4 class="font-black text-sm text-red-600 flex items-center gap-2"><i class="fas fa-receipt"></i> النثريات</h4>
                    <span id="expense-count" class="bg-red-100 text-red-600 text-[10px] px-2 py-0.5 rounded-full font-black">0</span>
                </div>
                <div id="expenses-list" class="flex-1 overflow-y-auto p-3 space-y-2">
                    </div>
            </div>
        </div>
    </main>

    <div id="modal-vault" class="fixed inset-0 z-[100] hidden bg-black/60 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-3xl shadow-2xl p-6">
            <h3 class="text-lg font-black mb-4 flex items-center gap-2"><i class="fas fa-university text-emerald-500"></i> رأس مال الخزنة</h3>
            <p class="text-xs text-slate-500 mb-4 leading-relaxed">أدخل المبلغ الإجمالي المتوفر في الخزنة لبداية هذا الشهر.</p>
            <input type="number" id="vault-input" class="w-full bg-slate-100 border-none rounded-xl px-4 py-3 font-black text-center text-xl focus:ring-2 ring-emerald-500 mb-4" placeholder="0.00">
            <div class="flex gap-2">
                <button onclick="saveVaultAmount()" class="flex-1 bg-slate-900 text-white font-black py-3 rounded-xl hover:bg-emerald-600 transition">تحديث الرصيد</button>
                <button onclick="closeVaultModal()" class="px-4 bg-slate-100 text-slate-400 rounded-xl hover:bg-red-50 hover:text-red-500"><i class="fas fa-times"></i></button>
            </div>
        </div>
    </div>

    <div id="modal-expense" class="fixed inset-0 z-[100] hidden bg-black/60 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-3xl shadow-2xl p-6">
            <h3 class="text-lg font-black mb-4 text-red-600">إضافة مصروف نثريات</h3>
            <div class="space-y-3">
                <input type="text" id="exp-title" placeholder="بيان المصروف (مثلاً: فاتورة كهرباء)" class="w-full bg-slate-100 border-none rounded-xl px-4 py-3 text-xs font-bold focus:ring-2 ring-red-500">
                <input type="number" id="exp-amount" placeholder="المبلغ" class="w-full bg-slate-100 border-none rounded-xl px-4 py-3 text-xs font-bold focus:ring-2 ring-red-500">
                <input type="date" id="exp-date" class="w-full bg-slate-100 border-none rounded-xl px-4 py-3 text-xs font-bold focus:ring-2 ring-red-500">
            </div>
            <div class="flex gap-2 mt-6">
                <button onclick="saveExpense()" class="flex-1 bg-red-600 text-white font-black py-3 rounded-xl hover:bg-red-700 transition shadow-lg shadow-red-500/20">إضافة للمصاريف</button>
                <button onclick="closeExpenseModal()" class="px-4 bg-slate-100 text-slate-400 rounded-xl hover:bg-slate-200 transition"><i class="fas fa-times"></i></button>
            </div>
        </div>
    </div>

    <div id="modal-finance" class="fixed inset-0 z-[100] hidden bg-black/60 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-xl rounded-3xl shadow-2xl overflow-hidden">
            <div class="p-6 border-b flex justify-between items-center bg-slate-50">
                <h3 class="text-lg font-black text-slate-800">تعديل مخصصات الموظف لشهر <span class="current-month-text"></span></h3>
                <button onclick="closeFinanceModal()" class="text-slate-400 hover:text-red-500 transition"><i class="fas fa-times text-xl"></i></button>
            </div>
            <form onsubmit="saveFinanceData(event)" class="p-6 space-y-4">
                <input type="hidden" id="fin-email">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-[10px] font-black text-slate-400 uppercase mb-1">الراتب الأساسي</label>
                        <input type="number" id="fin-salary" step="0.01" class="w-full bg-slate-50 border-none rounded-xl px-4 py-3 focus:ring-2 ring-emerald-500 font-bold">
                    </div>
                    <div>
                        <label class="block text-[10px] font-black text-slate-400 uppercase mb-1">رقم الموبايل</label>
                        <input type="text" id="fin-phone" class="w-full bg-slate-50 border-none rounded-xl px-4 py-3 focus:ring-2 ring-emerald-500 font-bold">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-[10px] font-black text-slate-400 uppercase mb-1">الحساب البنكي</label>
                        <input type="text" id="fin-bank" class="w-full bg-slate-50 border-none rounded-xl px-4 py-3 focus:ring-2 ring-emerald-500 font-bold">
                    </div>
                    <div>
                        <label class="block text-[10px] font-black text-pink-600 uppercase mb-1">Instapay</label>
                        <input type="text" id="fin-instapay" class="w-full bg-pink-50 border-none rounded-xl px-4 py-3 focus:ring-2 ring-pink-500 font-bold" dir="ltr">
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-3 border-t pt-4 bg-slate-50 p-3 rounded-2xl">
                    <div>
                        <label class="block text-[9px] font-black text-green-600 uppercase mb-1">المكافآت</label>
                        <input type="number" id="fin-bonus" step="0.01" value="0" class="w-full bg-white border-none rounded-lg px-3 py-2 focus:ring-2 ring-green-500 font-black">
                    </div>
                    <div>
                        <label class="block text-[9px] font-black text-blue-600 uppercase mb-1">الحوافز</label>
                        <input type="number" id="fin-incentive" step="0.01" value="0" class="w-full bg-white border-none rounded-lg px-3 py-2 focus:ring-2 ring-blue-500 font-black">
                    </div>
                    <div>
                        <label class="block text-[9px] font-black text-red-600 uppercase mb-1">الخصومات</label>
                        <input type="number" id="fin-deduction" step="0.01" value="0" class="w-full bg-white border-none rounded-lg px-3 py-2 focus:ring-2 ring-red-500 font-black">
                    </div>
                </div>
                <button type="submit" class="w-full bg-slate-900 text-white font-black py-4 rounded-2xl hover:bg-emerald-600 transition shadow-lg mt-2">تحديث السجل المالي</button>
            </form>
        </div>
    </div>

    <script>
        const firebaseConfig = { 
            apiKey: "AIzaSyCXyuT529aGwiS5j_RPxW_zEeAtkYc7JlM", 
            authDomain: "almaster-b8c18.firebaseapp.com", 
            projectId: "almaster-b8c18", 
            storageBucket: "almaster-b8c18.firebasestorage.app", 
            messagingSenderId: "884142036232", 
            appId: "1:884142036232:web:eeb6677d988565653a08bd" 
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const DEFAULT_PHOTO = 'https://ui-avatars.com/api/?background=0ea5e9&color=fff&bold=true&name=';

        let currentSelectedMonth = ""; 
        let allUsers = [];
        let monthFinancialData = { vault: 0, expenses: [] };

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                const doc = await db.collection('users').doc(user.email.toLowerCase()).get();
                if (doc.exists && doc.data().role === 'admin') {
                    initMonthPicker();
                    document.getElementById('payroll-loader').classList.add('hidden');
                } else { window.location.href = 'index.html'; }
            } else { window.location.href = 'index.html'; }
        });

        function initMonthPicker() {
            const picker = document.getElementById('month-picker');
            const now = new Date();
            for (let i = 0; i < 12; i++) {
                const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const val = `${d.getFullYear()}-${(d.getMonth() + 1).toString().padStart(2, '0')}`;
                const label = new Intl.DateTimeFormat('ar-EG', { month: 'long', year: 'numeric' }).format(d);
                picker.innerHTML += `<option value="${val}">${label}</option>`;
            }
            currentSelectedMonth = picker.value;
            syncMonthData();
        }

        async function syncMonthData() {
            // الاستماع لبيانات الشهر (الخزنة والمصاريف)
            db.collection("financial_months").doc(currentSelectedMonth).onSnapshot(doc => {
                if (doc.exists) {
                    monthFinancialData = doc.data();
                } else {
                    monthFinancialData = { vault: 0, expenses: [] };
                    db.collection("financial_months").doc(currentSelectedMonth).set(monthFinancialData);
                }
                loadUsersAndRender();
                renderExpenses();
            });
        }

        function loadUsersAndRender() {
            // الاستماع للموظفين
            db.collection("users").onSnapshot(snapshot => {
                allUsers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderPayroll();
            });
        }

        function renderPayroll() {
            const tbody = document.getElementById('payroll-body');
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            tbody.innerHTML = '';
            
            let totalNetExpected = 0;
            let totalActuallyPaid = 0;
            let paidCount = 0;
            let pendingCount = 0;

            allUsers.forEach(u => {
                if (u.name.toLowerCase().includes(searchTerm)) {
                    // البيانات المالية تكون مخزنة داخل أوبجيكت باسم الشهر لتجنب التضارب
                    const mData = (u.monthly_finance && u.monthly_finance[currentSelectedMonth]) || {};
                    
                    const base = parseFloat(u.salary_base) || 0;
                    const bonus = parseFloat(mData.bonus) || 0;
                    const incentive = parseFloat(mData.incentive) || 0;
                    const deduct = parseFloat(mData.deduction) || 0;
                    const net = base + bonus + incentive - deduct;
                    const status = mData.status || 'pending';

                    totalNetExpected += net;
                    if(status === 'paid') {
                        paidCount++;
                        totalActuallyPaid += net;
                    } else pendingCount++;

                    tbody.innerHTML += `
                        <tr class="hover:bg-slate-50 transition border-b border-slate-100">
                            <td class="p-4">
                                <div class="flex items-center gap-3">
                                    <img src="${u.photo || DEFAULT_PHOTO + u.name}" class="w-9 h-9 rounded-xl object-cover border bg-slate-100 shadow-sm">
                                    <div>
                                        <p class="text-xs font-black text-slate-800 leading-tight">${u.name}</p>
                                        <p class="text-[9px] font-bold text-slate-400 uppercase tracking-tighter">${u.title || 'Member'}</p>
                                    </div>
                                </div>
                            </td>
                            <td class="p-4 font-bold text-slate-500">${base.toLocaleString()}</td>
                            <td class="p-4 font-bold text-green-600">+${bonus}</td>
                            <td class="p-4 font-bold text-blue-600">+${incentive}</td>
                            <td class="p-4 font-bold text-red-500">-${deduct}</td>
                            <td class="p-4 font-black text-slate-900 bg-slate-50/50">${net.toLocaleString()} EGP</td>
                            <td class="p-4">
                                <div class="space-y-0.5 opacity-80">
                                    <p class="text-[9px] font-black text-slate-700 truncate w-32"><i class="fas fa-university ml-1 text-slate-300"></i> ${u.bank_account || '---'}</p>
                                    ${u.instapay ? `<p class="text-[9px] font-black text-pink-600"><i class="fas fa-at ml-1"></i> ${u.instapay}</p>` : ''}
                                </div>
                            </td>
                            <td class="p-4">${renderStatusBadge(status, u.id)}</td>
                            <td class="p-4 text-center">
                                <button onclick="openFinanceModal('${u.id}')" class="w-8 h-8 rounded-lg bg-slate-100 text-slate-500 hover:bg-slate-900 hover:text-white transition flex items-center justify-center mx-auto shadow-sm">
                                    <i class="fas fa-pen text-[10px]"></i>
                                </button>
                            </td>
                        </tr>`;
                }
            });

            // حساب الإحصائيات الكلية
            const totalExp = monthFinancialData.expenses.reduce((sum, e) => sum + parseFloat(e.amount), 0);
            const totalSpentCombined = totalActuallyPaid + totalExp;
            const vault = parseFloat(monthFinancialData.vault) || 0;

            document.getElementById('total-net-salaries').innerText = totalNetExpected.toLocaleString();
            document.getElementById('total-paid-amount').innerText = totalActuallyPaid.toLocaleString();
            document.getElementById('total-spent').innerText = totalSpentCombined.toLocaleString();
            document.getElementById('total-expenses').innerText = totalExp.toLocaleString();
            document.getElementById('vault-balance').innerText = vault.toLocaleString();
            document.getElementById('remaining-vault').innerText = (vault - totalSpentCombined).toLocaleString();
            document.getElementById('paid-count').innerText = paidCount;
            document.getElementById('pending-count').innerText = pendingCount;
            document.getElementById('expense-count').innerText = monthFinancialData.expenses.length;
        }

        function renderExpenses() {
            const list = document.getElementById('expenses-list');
            list.innerHTML = '';
            monthFinancialData.expenses.forEach((exp, idx) => {
                list.innerHTML += `
                    <div class="bg-slate-50 border border-slate-100 p-3 rounded-2xl relative group">
                        <div class="flex justify-between items-start mb-1">
                            <p class="text-xs font-black text-slate-800">${exp.title}</p>
                            <span class="text-[11px] font-black text-red-600">${parseFloat(exp.amount).toLocaleString()}</span>
                        </div>
                        <div class="flex justify-between items-center text-[9px] font-bold text-slate-400 uppercase">
                            <span><i class="far fa-calendar-alt ml-1"></i> ${exp.date}</span>
                            <button onclick="deleteExpense(${idx})" class="text-red-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    </div>`;
            });
        }

        function renderStatusBadge(status, email) {
            const config = {
                'pending': { color: 'bg-orange-100 text-orange-600', text: 'انتظار', icon: 'fa-clock' },
                'approved': { color: 'bg-blue-100 text-blue-600', text: 'معتمد', icon: 'fa-check' },
                'paid': { color: 'bg-green-100 text-green-600', text: 'تم الدفع', icon: 'fa-check-double' }
            }[status] || { color: 'bg-slate-100', text: '---', icon: 'fa-minus' };
            
            return `
                <div class="group relative inline-block">
                    <button class="flex items-center gap-2 px-3 py-1.5 rounded-lg text-[9px] font-black ${config.color} min-w-[85px] justify-center shadow-sm">
                        <i class="fas ${config.icon} text-[8px]"></i> ${config.text}
                    </button>
                    <div class="hidden group-hover:flex absolute right-0 top-full mt-1 bg-white shadow-2xl rounded-xl border border-slate-100 p-1 z-50 flex-col gap-1 w-28 animate-fade-in">
                        <button onclick="updatePaymentStatus('${email}', 'pending')" class="text-[9px] font-bold p-2 hover:bg-orange-50 text-orange-600 rounded-lg text-right">قيد الانتظار</button>
                        <button onclick="updatePaymentStatus('${email}', 'approved')" class="text-[9px] font-bold p-2 hover:bg-blue-50 text-blue-600 rounded-lg text-right">تم الاعتماد</button>
                        <button onclick="updatePaymentStatus('${email}', 'paid')" class="text-[9px] font-bold p-2 hover:bg-green-50 text-green-600 rounded-lg text-right">تم التحويل</button>
                    </div>
                </div>`;
        }

        async function updatePaymentStatus(email, status) {
            const userRef = db.collection("users").doc(email);
            const user = allUsers.find(u => u.id === email);
            const monthlyFinance = user.monthly_finance || {};
            if(!monthlyFinance[currentSelectedMonth]) monthlyFinance[currentSelectedMonth] = {};
            monthlyFinance[currentSelectedMonth].status = status;
            await userRef.update({ monthly_finance: monthlyFinance });
        }

        // Vault Logic
        function openVaultModal() { document.getElementById('vault-input').value = monthFinancialData.vault; document.getElementById('modal-vault').classList.remove('hidden'); }
        function closeVaultModal() { document.getElementById('modal-vault').classList.add('hidden'); }
        async function saveVaultAmount() {
            const amount = parseFloat(document.getElementById('vault-input').value) || 0;
            await db.collection("financial_months").doc(currentSelectedMonth).update({ vault: amount });
            closeVaultModal();
        }

        // Expenses Logic
        function openExpenseModal() { document.getElementById('exp-date').valueAsDate = new Date(); document.getElementById('modal-expense').classList.remove('hidden'); }
        function closeExpenseModal() { document.getElementById('modal-expense').classList.add('hidden'); }
        async function saveExpense() {
            const title = document.getElementById('exp-title').value;
            const amount = parseFloat(document.getElementById('exp-amount').value);
            const date = document.getElementById('exp-date').value;
            if(!title || !amount) return alert("أكمل البيانات");
            
            const newExpenses = [...monthFinancialData.expenses, { title, amount, date }];
            await db.collection("financial_months").doc(currentSelectedMonth).update({ expenses: newExpenses });
            closeExpenseModal();
            document.getElementById('exp-title').value = ''; document.getElementById('exp-amount').value = '';
        }
        async function deleteExpense(idx) {
            if(!confirm("حذف المصروف؟")) return;
            const newExpenses = [...monthFinancialData.expenses];
            newExpenses.splice(idx, 1);
            await db.collection("financial_months").doc(currentSelectedMonth).update({ expenses: newExpenses });
        }

        function openFinanceModal(email) {
            const user = allUsers.find(u => u.id === email);
            if (!user) return;
            const mData = (user.monthly_finance && user.monthly_finance[currentSelectedMonth]) || {};
            document.getElementById('fin-email').value = email;
            document.getElementById('fin-salary').value = user.salary_base || 0;
            document.getElementById('fin-phone').value = user.phone_number || "";
            document.getElementById('fin-bank').value = user.bank_account || "";
            document.getElementById('fin-instapay').value = user.instapay || "";
            document.getElementById('fin-bonus').value = mData.bonus || 0;
            document.getElementById('fin-incentive').value = mData.incentive || 0;
            document.getElementById('fin-deduction').value = mData.deduction || 0;
            document.querySelector('.current-month-text').innerText = currentSelectedMonth;
            document.getElementById('modal-finance').classList.remove('hidden');
        }

        function closeFinanceModal() { document.getElementById('modal-finance').classList.add('hidden'); }

        async function saveFinanceData(e) {
            e.preventDefault();
            const email = document.getElementById('fin-email').value;
            const user = allUsers.find(u => u.id === email);
            
            const monthlyFinance = user.monthly_finance || {};
            if(!monthlyFinance[currentSelectedMonth]) monthlyFinance[currentSelectedMonth] = { status: 'pending' };
            
            monthlyFinance[currentSelectedMonth].bonus = parseFloat(document.getElementById('fin-bonus').value) || 0;
            monthlyFinance[currentSelectedMonth].incentive = parseFloat(document.getElementById('fin-incentive').value) || 0;
            monthlyFinance[currentSelectedMonth].deduction = parseFloat(document.getElementById('fin-deduction').value) || 0;

            const globalData = {
                salary_base: parseFloat(document.getElementById('fin-salary').value) || 0,
                phone_number: document.getElementById('fin-phone').value || "",
                bank_account: document.getElementById('fin-bank').value || "",
                instapay: document.getElementById('fin-instapay').value || "",
                monthly_finance: monthlyFinance
            };

            await db.collection("users").doc(email).update(globalData);
            closeFinanceModal();
        }

        function changeMonth() {
            currentSelectedMonth = document.getElementById('month-picker').value;
            syncMonthData();
        }

        function exportToExcel() {
            const data = [];
            // Header Info
            data.push(["تقرير ALMASTER المالي لشهر", currentSelectedMonth]);
            data.push(["الخزنة الافتتاحية", document.getElementById('vault-balance').innerText]);
            data.push(["إجمالي المصروفات", document.getElementById('total-spent').innerText]);
            data.push(["المتبقي في الخزنة", document.getElementById('remaining-vault').innerText]);
            data.push([]);
            
            // Payroll Table
            data.push(["كشف المرتبات"]);
            data.push(["الاسم", "الأساسي", "المكافآت", "الحوافز", "الخصومات", "صافي المرتب", "الحالة"]);
            allUsers.forEach(u => {
                const mData = (u.monthly_finance && u.monthly_finance[currentSelectedMonth]) || {};
                const base = parseFloat(u.salary_base) || 0;
                const bonus = parseFloat(mData.bonus) || 0;
                const incentive = parseFloat(mData.incentive) || 0;
                const deduct = parseFloat(mData.deduction) || 0;
                const net = base + bonus + incentive - deduct;
                data.push([u.name, base, bonus, incentive, deduct, net, mData.status || 'pending']);
            });

            data.push([]);
            // Expenses Table
            data.push(["كشف النثريات"]);
            data.push(["البيان", "المبلغ", "التاريخ"]);
            monthFinancialData.expenses.forEach(e => {
                data.push([e.title, e.amount, e.date]);
            });

            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Financial Report");
            XLSX.writeFile(wb, `Almaster_Financial_${currentSelectedMonth}.xlsx`);
        }
    </script>
</body>
</html>
