<!DOCTYPE html>
<html lang="ar" dir="rtl" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø³Ø§Ø­Ø© Ø¹Ù…Ù„ Ø§Ù„Ù…ÙˆØ¸Ù | ALMASTER</title>
    <meta name="theme-color" content="#020617">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&family=Outfit:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: { primary: { 500: '#0ea5e9', 600: '#0284c7' }, dark: { 800: '#1e293b', 900: '#0f172a', 950: '#020617' } },
                    fontFamily: { sans: ['Outfit', 'Cairo', 'sans-serif'] }
                }
            }
        }
    </script>

    <style>
        body { background-color: #020617; color: #f1f5f9; height: 100vh; overflow: hidden; display: flex; flex-direction: column; margin: 0; }
        .hidden-section { display: none !important; }
        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 20px; }
        
        .status-card-active { transform: scale(1.03); border-width: 2px; }
        .active-Online { background-color: #064e3b !important; border-color: #10b981 !important; box-shadow: 0 0 20px rgba(16, 185, 129, 0.2); }
        .active-Break { background-color: #78350f !important; border-color: #f59e0b !important; box-shadow: 0 0 20px rgba(245, 158, 11, 0.2); }
        .active-Meeting { background-color: #1e3a8a !important; border-color: #3b82f6 !important; box-shadow: 0 0 20px rgba(59, 130, 246, 0.2); }

        .task-card { background: #0f172a; border: 1px solid #1e293b; transition: all 0.2s; }
        .task-card:hover { border-color: #0ea5e9; background: #1e293b; }
        .task-card.active { border-right: 5px solid #0ea5e9; background: #1e293b; }

        #users-dropdown.active { display: block !important; animation: slideDown 0.2s ease-out; }
        @keyframes slideDown { from { transform: translateY(-10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .chat-window { position: fixed; z-index: 100; display: flex; flex-direction: column; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
    </style>
</head>

<body class="dark">

    <div id="loader" class="fixed inset-0 z-[300] bg-dark-950 flex flex-col items-center justify-center">
        <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-primary-500 mb-4"></div>
        <h2 id="loader-text" class="text-lg font-bold animate-pulse tracking-widest uppercase">Initializing Workspace</h2>
    </div>

    <header class="h-16 border-b border-white/5 bg-dark-900 px-6 flex items-center justify-between shrink-0 z-50">
        <div class="flex items-center gap-4">
            <img src="MASTER_LOGO_WHPNG.png" class="h-8 object-contain" onerror="this.src='https://ui-avatars.com/api/?background=0ea5e9&color=fff&name=AL'">
            <div class="h-6 w-[1px] bg-white/10 mx-2"></div>
            <h2 class="text-sm font-black tracking-tight text-slate-400 uppercase">Employee Workspace</h2>
        </div>
        <div class="flex flex-col items-center">
            <div id="header-time" class="text-xl font-black font-mono tracking-widest text-primary-500">00:00:00</div>
            <div id="header-date" class="text-[9px] font-bold text-slate-500 uppercase">Loading Date...</div>
        </div>
        <div class="flex items-center gap-3">
            <div class="flex items-center gap-2 text-[10px] font-bold text-green-500 bg-green-500/10 px-3 py-1 rounded-full border border-green-500/20">
                <span class="w-1.5 h-1.5 rounded-full bg-green-500 animate-ping"></span> Live
            </div>
        </div>
    </header>

    <main class="flex-1 flex overflow-hidden">
        
        <aside class="w-1/3 max-w-[380px] border-l border-white/5 p-6 flex flex-col gap-6 overflow-y-auto custom-scrollbar bg-dark-950/50 h-full shrink-0">
            
            <div class="flex items-center gap-4 p-5 rounded-3xl bg-dark-900 border border-white/5 shrink-0 shadow-xl">
                <div class="relative">
                    <img id="user-img" src="" class="w-16 h-16 rounded-2xl object-cover border-2 border-primary-500 shadow-xl bg-dark-800">
                    <span id="user-status-dot" class="absolute -bottom-1 -right-1 w-4 h-4 rounded-full border-2 border-dark-900 bg-slate-500"></span>
                </div>
                <div class="overflow-hidden text-right flex-1">
                    <h3 id="user-name" class="font-black text-lg truncate">Loading...</h3>
                    <p id="user-role" class="text-[10px] text-primary-500 font-bold uppercase tracking-widest mb-2">Member</p>
                    <button onclick="openLogsModal()" class="text-[10px] font-black text-slate-400 hover:text-primary-500 transition uppercase flex items-center gap-2">
                        <i class="fas fa-history"></i> Ø³Ø¬Ù„ Ø§Ù„Ø­Ø±ÙƒØ§Øª (History)
                    </button>
                </div>
            </div>

            <div class="space-y-3">
                <p class="text-[10px] font-black text-slate-500 uppercase tracking-widest mr-2">Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙˆØ­Ø§Ù„Ø© Ø§Ù„ÙŠÙˆÙ…:</p>
                <div id="card-Online" onclick="handleStatusClick('Online')" class="group cursor-pointer transition-all p-4 rounded-2xl border border-white/5 bg-dark-900 flex items-center justify-between hover:border-green-500/40">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 rounded-xl bg-green-500/10 text-green-500 flex items-center justify-center transition group-hover:scale-110"><i class="fas fa-laptop-code text-lg"></i></div>
                        <div><p class="text-[10px] font-black opacity-50 uppercase">ÙˆÙ‚Øª Ø§Ù„Ø¹Ù…Ù„</p><p id="timer-online" class="text-base font-black stat-timer" data-val="0" data-active="false" data-start="0">00:00:00</p></div>
                    </div>
                </div>
                <div id="card-Break" onclick="handleStatusClick('Break')" class="group cursor-pointer transition-all p-4 rounded-2xl border border-white/5 bg-dark-900 flex items-center justify-between hover:border-orange-500/40">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 rounded-xl bg-orange-500/10 text-orange-500 flex items-center justify-center transition group-hover:scale-110"><i class="fas fa-coffee text-lg"></i></div>
                        <div><p class="text-[10px] font-black opacity-50 uppercase">Ø§Ø³ØªØ±Ø§Ø­Ø©</p><p id="timer-break" class="text-base font-black stat-timer" data-val="0" data-active="false" data-start="0">00:00:00</p></div>
                    </div>
                </div>
                <div id="card-Meeting" onclick="handleStatusClick('Meeting')" class="group cursor-pointer transition-all p-4 rounded-2xl border border-white/5 bg-dark-900 flex items-center justify-between hover:border-blue-500/40">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 rounded-xl bg-blue-500/10 text-blue-500 flex items-center justify-center transition group-hover:scale-110"><i class="fas fa-users text-lg"></i></div>
                        <div><p class="text-[10px] font-black opacity-50 uppercase">Ø§Ø¬ØªÙ…Ø§Ø¹</p><p id="timer-meeting" class="text-base font-black stat-timer" data-val="0" data-active="false" data-start="0">00:00:00</p></div>
                    </div>
                </div>
            </div>

            <div class="bg-red-500/5 border border-red-500/10 p-4 rounded-2xl flex items-center gap-4 shrink-0">
                <div class="w-10 h-10 rounded-full bg-red-500/20 text-red-500 flex items-center justify-center animate-pulse"><i class="fas fa-keyboard"></i></div>
                <div><p class="text-[10px] font-black text-red-400 opacity-60 uppercase">Ø§Ù„Ø®Ù…ÙˆÙ„ (Idle)</p><p id="timer-idle" class="text-lg font-black text-red-600 stat-idle" data-val="0" data-isidle="false" data-start="0">00:00:00</p></div>
            </div>

            <div class="pt-4 border-t border-white/5 space-y-3 shrink-0">
                <button onclick="toggleChat()" class="w-full py-4 bg-primary-600/10 text-primary-500 rounded-2xl border border-primary-500/20 font-black text-xs hover:bg-primary-600 hover:text-white transition flex items-center justify-center gap-3 relative">
                    <i class="fas fa-globe"></i> Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø¹Ø§Ù…Ø©
                    <span id="chat-badge" class="absolute left-4 top-1/2 -translate-y-1/2 bg-red-500 text-white text-[9px] w-5 h-5 rounded-full flex items-center justify-center hidden border-2 border-dark-950 font-bold">!</span>
                </button>

                <div class="relative">
                    <button onclick="toggleUsersDropdown()" class="w-full py-4 bg-dark-900 border border-white/10 rounded-2xl flex items-center justify-between px-5 hover:border-primary-500 transition shadow-sm">
                        <span class="text-xs font-black text-slate-300">ğŸ’¬ Ù…Ø­Ø§Ø¯Ø«Ø© Ø®Ø§ØµØ© (Ø§Ù„Ø²Ù…Ù„Ø§Ø¡)</span>
                        <i class="fas fa-chevron-down text-[10px] text-slate-500"></i>
                    </button>
                    <div id="users-dropdown" class="absolute bottom-full left-0 right-0 mb-2 bg-dark-800 border border-white/10 rounded-2xl shadow-2xl max-h-64 overflow-y-auto custom-scrollbar z-[60] hidden">
                        <div id="users-list-content" class="p-2 space-y-1"></div>
                    </div>
                </div>
            </div>

            <button onclick="logout()" class="mt-auto w-full py-4 rounded-2xl bg-red-500/10 text-red-500 font-black hover:bg-red-500 hover:text-white transition flex items-center justify-center gap-3 shrink-0 mb-4">
                <i class="fas fa-sign-out-alt"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
            </button>
        </aside>

        <section class="flex-1 flex overflow-hidden">
            <div class="w-80 border-l border-white/5 bg-dark-900 flex flex-col shrink-0 h-full">
                <div class="p-6 border-b border-white/5 bg-dark-950/30">
                    <h3 class="font-black text-lg flex items-center gap-3 mb-4"><i class="fas fa-tasks text-primary-500"></i> Ù…Ù‡Ø§Ù… Ø§Ù„Ø¹Ù…Ù„</h3>
                    <div class="flex p-1 bg-dark-950 rounded-xl border border-white/5">
                        <button onclick="changeTaskTab(false, this)" class="task-tab-btn flex-1 py-2 text-[11px] font-black rounded-lg bg-dark-800 text-white shadow-lg">Ø§Ù„Ø­Ø§Ù„ÙŠØ©</button>
                        <button onclick="changeTaskTab(true, this)" class="task-tab-btn flex-1 py-2 text-[11px] font-black rounded-lg text-slate-500 transition">Ø§Ù„Ø£Ø±Ø´ÙŠÙ</button>
                    </div>
                </div>
                <div id="task-list" class="flex-1 overflow-y-auto p-4 space-y-3 custom-scrollbar"></div>
            </div>

            <div id="task-detail-pane" class="flex-1 bg-dark-950 flex flex-col relative h-full overflow-hidden">
                <div id="task-empty-state" class="flex-1 flex flex-col items-center justify-center text-slate-700 h-full animate-fade-in">
                    <i class="fas fa-folder-open text-8xl mb-4 opacity-10"></i>
                    <p class="font-bold text-lg">Ø§Ø®ØªØ± Ù…Ù‡Ù…Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„</p>
                </div>

                <div id="task-content" class="hidden flex flex-col h-full overflow-hidden">
                    <div class="flex-1 overflow-y-auto p-8 custom-scrollbar">
                        <div class="max-w-4xl mx-auto">
                            <div class="flex justify-between items-start mb-8">
                                <div class="flex-1">
                                    <div id="task-project-tag"></div>
                                    <h1 id="task-title" class="text-3xl font-black text-white mb-3">Task Title</h1>
                                    <div class="flex items-center gap-4 text-xs text-slate-500 bg-white/5 px-4 py-2 rounded-xl border border-white/5 w-fit">
                                        <span><i class="far fa-calendar-alt text-primary-500 ml-1"></i> <span id="task-date"></span></span>
                                        <div class="w-1 h-1 rounded-full bg-slate-700"></div>
                                        <span><i class="fas fa-user-edit text-primary-500 ml-1"></i> Ø§Ù„Ø¥Ø³Ù†Ø§Ø¯: <span id="task-assigner" class="font-bold text-slate-300">Admin</span></span>
                                    </div>
                                </div>
                                <div id="task-status-badge"></div>
                            </div>
                            <div id="task-desc" class="text-lg leading-relaxed text-slate-300 bg-white/5 p-8 rounded-3xl border border-white/5 mb-8 font-cairo"></div>
                            <div id="task-files" class="grid grid-cols-1 gap-3 mb-10"></div>
                            <div class="space-y-6 pb-20">
                                <h4 class="font-black text-sm border-r-4 border-primary-500 pr-3">Ø§Ù„Ù…Ù†Ø§Ù‚Ø´Ø§Øª ÙˆØ§Ù„Ø±Ø¯ÙˆØ¯</h4>
                                <div id="task-comments" class="space-y-4"></div>
                            </div>
                        </div>
                    </div>

                    <div class="p-6 bg-dark-900 border-t border-white/5 flex flex-col gap-4 shrink-0">
                        <div id="task-action-controls" class="flex gap-3"></div>
                        <form onsubmit="handleCommentSubmit(event)" class="flex gap-3 items-center bg-dark-950 p-2 rounded-2xl border border-white/10 shadow-lg">
                            <input type="file" id="comment-file" class="hidden" onchange="handleFileSelect(this)">
                            <button type="button" onclick="document.getElementById('comment-file').click()" class="w-12 h-11 rounded-xl hover:bg-white/5 text-slate-500 transition"><i class="fas fa-paperclip text-lg"></i></button>
                            <input type="text" id="comment-input" class="flex-1 bg-transparent border-none focus:ring-0 text-sm text-white" placeholder="Ø§ÙƒØªØ¨ Ø±Ø¯Ùƒ Ù‡Ù†Ø§..." autocomplete="off">
                            <button type="submit" id="comment-btn" class="w-14 h-11 bg-primary-600 rounded-xl hover:bg-primary-500 transition shadow-lg"><i class="fas fa-paper-plane"></i></button>
                        </form>
                        <div id="file-preview" class="hidden px-4 text-[10px] text-primary-500 font-bold"></div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <div id="chat-window" class="chat-window fixed top-20 left-10 w-[400px] h-[600px] bg-dark-900 border border-white/10 rounded-3xl overflow-hidden hidden animate-fade-in flex flex-col">
        <div class="p-5 bg-dark-950 border-b border-white/5 flex justify-between items-center chat-header cursor-move">
            <h3 class="font-black text-sm"><i class="fas fa-globe-africa mr-2 text-primary-500"></i>Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø¹Ø§Ù…Ø©</h3>
            <button onclick="toggleChat()" class="text-slate-500 hover:text-red-500"><i class="fas fa-times"></i></button>
        </div>
        <div id="chat-messages" class="flex-1 overflow-y-auto p-5 space-y-3 custom-scrollbar"></div>
        <form onsubmit="handleGlobalMessage(event)" class="p-4 bg-dark-900 border-t border-white/5 flex gap-2">
            <input type="text" id="chat-input" class="flex-1 bg-dark-950 border border-white/5 rounded-xl px-4 py-2.5 text-xs text-white" placeholder="Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø¬Ù…ÙŠØ¹..." autocomplete="off">
            <button type="submit" class="w-11 h-11 bg-primary-600 rounded-xl flex items-center justify-center shadow-lg"><i class="fas fa-paper-plane text-sm"></i></button>
        </form>
    </div>

    <div id="private-chats-container"></div>

    <div id="modal-qa" class="fixed inset-0 z-[250] hidden bg-black/90 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-dark-900 w-full max-w-sm rounded-[2rem] p-8 border border-primary-500/20 shadow-2xl">
            <h3 class="text-xl font-black text-primary-500 mb-4 text-center">Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© ğŸ‘ï¸â€ğŸ—¨ï¸</h3>
            <p class="text-xs text-slate-400 mb-6 text-center leading-relaxed">ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ù…Ù‡Ù…Ø© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹.</p>
            <input type="hidden" id="review-task-id">
            <select id="qa-manager-select" class="form-input font-black mb-6"></select>
            <div class="flex gap-2">
                <button onclick="confirmQA()" class="flex-1 bg-primary-600 py-3 rounded-xl font-black">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</button>
                <button onclick="closeModal('modal-qa')" class="px-6 py-3 bg-dark-800 rounded-xl font-bold">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <div id="modal-logs" class="fixed inset-0 z-[250] hidden bg-black/90 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-dark-900 w-full max-w-xl rounded-[2.5rem] flex flex-col max-h-[80vh] border border-white/5 shadow-2xl overflow-hidden">
            <div class="p-6 border-b border-white/5 flex justify-between items-center bg-dark-950/50">
                <h3 class="font-black text-lg"><i class="fas fa-history text-primary-500 ml-2"></i>Ø³Ø¬Ù„ Ø­Ø±ÙƒØ§Øª Ø§Ù„ÙŠÙˆÙ…</h3>
                <button onclick="closeModal('modal-logs')" class="text-slate-500 hover:text-white transition"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto p-6 custom-scrollbar" id="logs-timeline"></div>
        </div>
    </div>

    <div id="img-preview-modal" class="fixed inset-0 z-[300] bg-black/95 flex items-center justify-center p-4 hidden" onclick="this.classList.add('hidden')">
        <img id="preview-target" src="" class="max-w-full max-h-full rounded-lg shadow-2xl">
    </div>

    <script>
        // 1. Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ§Øª ÙˆØ§Ù„ØªÙ‡ÙŠØ¦Ø©
        const firebaseConfig = { apiKey: "AIzaSyCXyuT529aGwiS5j_RPxW_zEeAtkYc7JlM", authDomain: "almaster-b8c18.firebaseapp.com", projectId: "almaster-b8c18", storageBucket: "almaster-b8c18.firebasestorage.app", messagingSenderId: "884142036232", appId: "1:884142036232:web:eeb6677d988565653a08bd" };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const storage = firebase.storage();

        let currentUser = null, userProfile = null, allUsers = [];
        let currentTasks = [], historyMode = false, selectedTaskId = null, attachedFileObj = null, lastActionTime = Date.now();

        // 2. Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© (Helpers) - ØªÙ… ØªØ¹Ø±ÙŠÙÙ‡Ø§ ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… Ø­Ø¯ÙˆØ« Ø®Ø·Ø£ ReferenceError
        const getMillis = (v) => v ? (v.toMillis ? v.toMillis() : v) : Date.now();
        
        function startClock() {
            setInterval(() => {
                const now = moment();
                document.getElementById('header-time').innerText = now.format('HH:mm:ss');
                document.getElementById('header-date').innerText = now.format('dddd, DD MMMM YYYY');
            }, 1000);
        }

        function formatDurationLong(ms) {
            if(ms < 0) ms = 0;
            const s = Math.floor((ms/1000)%60).toString().padStart(2,'0');
            const m = Math.floor((ms/1000/60)%60).toString().padStart(2,'0');
            const h = Math.floor((ms/1000/60/60)).toString().padStart(2,'0');
            return `${h}:${m}:${s}`;
        }

        async function uploadFileToStorage(file, path) {
            if (!file) return null;
            const ref = storage.ref().child(`${path}/${Date.now()}_${file.name}`);
            await ref.put(file);
            return await ref.getDownloadURL();
        }

        // 3. Ù…Ø±Ø§Ù‚Ø¨ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„Ø®Ø±ÙˆØ¬
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                try {
                    const doc = await db.collection('users').doc(user.email.toLowerCase()).get();
                    if(doc.exists) {
                        userProfile = doc.data();
                        // ØªÙˆØ¬ÙŠÙ‡ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø­Ù…Ø§ÙŠØ©
                        if (userProfile.role === 'admin') { window.location.replace('admin.html'); return; }
                        initWorkspace();
                    } else { auth.signOut(); }
                } catch(e) { console.error("Auth Error", e); }
            } else { window.location.replace('index.html'); }
        });

        function initWorkspace() {
            try {
                startClock();
                listenToProfile();
                listenToAllUsers();
                initGlobalChat();
                listenToPrivateMessages();
                startIdleTracker();
                setInterval(updateTimersUI, 1000);
                document.getElementById('loader').classList.add('hidden');
                console.log("Workspace Ready âœ…");
            } catch(e) { console.error("Init Error", e); alert("Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù…: " + e.message); }
        }

        // 4. Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­ÙŠØ©
        function listenToProfile() {
            db.collection('users').doc(currentUser.email.toLowerCase()).onSnapshot(doc => {
                if(!doc.exists) return;
                userProfile = doc.data();
                updateProfileUI(userProfile);
                currentTasks = userProfile.tasks || [];
                renderTasks();
                if(selectedTaskId) {
                    const task = currentTasks.find(t => t.id == selectedTaskId);
                    if(task) updateTaskDetail(task);
                }
            });
        }

        function listenToAllUsers() {
            db.collection('users').onSnapshot(snap => {
                allUsers = snap.docs.map(d => ({ email: d.id, ...d.data() }));
                renderUsersDropdown();
            });
        }

        // 5. ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© (UI)
        function updateProfileUI(data) {
            document.getElementById('user-name').innerText = data.name;
            document.getElementById('user-role').innerText = data.title || (data.role === 'leader' ? 'Team Leader' : 'Member');
            document.getElementById('user-img').src = data.photo || `https://ui-avatars.com/api/?background=0ea5e9&color=fff&bold=true&name=${data.name}`;
            
            const status = data.status || 'Offline';
            const tb = data.timeBank || {};
            const safeStart = getMillis(data.lastChange);

            // Update Timers Raw Data
            document.getElementById('timer-online').dataset.val = tb['Online'] || 0;
            document.getElementById('timer-online').dataset.active = status === 'Online';
            document.getElementById('timer-online').dataset.start = safeStart;

            document.getElementById('timer-break').dataset.val = tb['Break'] || 0;
            document.getElementById('timer-break').dataset.active = status === 'Break';
            document.getElementById('timer-break').dataset.start = safeStart;

            document.getElementById('timer-meeting').dataset.val = tb['Meeting'] || 0;
            document.getElementById('timer-meeting').dataset.active = status === 'Meeting';
            document.getElementById('timer-meeting').dataset.start = safeStart;

            document.getElementById('timer-idle').dataset.val = data.idleBank || 0;
            document.getElementById('timer-idle').dataset.isidle = data.isIdle;
            document.getElementById('timer-idle').dataset.start = getMillis(data.idleSince);

            // ğŸŸ¢ Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ© Ù„Ù„Ø¨Ø·Ø§Ù‚Ø§Øª ğŸŸ¢
            ['Online', 'Break', 'Meeting'].forEach(s => {
                const card = document.getElementById('card-' + s);
                if(!card) return;
                card.classList.remove('status-card-active', 'active-Online', 'active-Break', 'active-Meeting');
                if(s === status) card.classList.add('status-card-active', 'active-' + s);
            });
            
            const dot = document.getElementById('user-status-dot');
            dot.className = `absolute -bottom-1 -right-1 w-4 h-4 rounded-full border-2 border-dark-900 ${status==='Online'?'bg-green-500':status==='Break'?'bg-orange-500':'bg-blue-500'}`;
        }

        function updateTimersUI() {
            const now = Date.now();
            document.querySelectorAll('.stat-timer, .stat-idle').forEach(t => { 
                const b = parseInt(t.dataset.val)||0; const s = parseInt(t.dataset.start)||0; 
                const active = t.dataset.active==='true' || t.dataset.isidle==='true';
                t.innerText = formatDurationLong(active ? b+(now-s) : b); 
            });
        }

        // 6. Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ù…Ù‡Ø§Ù… (Tasks)
        function renderTasks() {
            const container = document.getElementById('task-list');
            if(!container) return;
            container.innerHTML = '';
            const filtered = currentTasks.filter(t => historyMode ? t.archived : !t.archived);
            filtered.sort((a,b) => b.id - a.id);

            filtered.forEach(t => {
                const isActive = selectedTaskId == t.id;
                const card = document.createElement('div');
                card.className = `task-card p-4 rounded-2xl cursor-pointer ${isActive ? 'active' : ''}`;
                card.onclick = () => selectTask(t);
                
                let icon = '<i class="fas fa-circle text-[8px] text-slate-700"></i>';
                if(t.status === 'working') icon = '<i class="fas fa-spinner fa-spin text-[8px] text-blue-500"></i>';
                if(t.status === 'review') icon = '<i class="fas fa-eye text-[8px] text-purple-500 animate-pulse"></i>';
                if(t.status === 'done') icon = '<i class="fas fa-check-circle text-[8px] text-green-500"></i>';

                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2"><h4 class="font-bold text-xs truncate w-44 text-slate-200">${t.title}</h4>${icon}</div>
                    <div class="flex justify-between items-center"><span class="text-[9px] font-bold text-slate-600">${moment(t.id).fromNow()}</span>${t.projectId ? `<span class="bg-primary-500/10 text-primary-400 text-[8px] px-2 py-0.5 rounded font-black border border-primary-500/10 uppercase">ERP</span>` : ''}</div>
                `;
                container.appendChild(card);
            });
        }

        function selectTask(task) {
            selectedTaskId = task.id;
            renderTasks();
            document.getElementById('task-empty-state').classList.add('hidden');
            document.getElementById('task-content').classList.remove('hidden');
            updateTaskDetail(task);
        }

        function updateTaskDetail(task) {
            document.getElementById('task-title').innerText = task.title;
            document.getElementById('task-desc').innerHTML = task.desc;
            document.getElementById('task-date').innerText = moment(task.id).format('D MMMM, h:mm A');
            document.getElementById('task-assigner').innerText = task.createdBy || "Admin";

            const tagBox = document.getElementById('task-project-tag');
            tagBox.innerHTML = task.projectId ? `<span class="bg-primary-500/10 text-primary-500 text-[10px] font-black px-4 py-1.5 rounded-full border border-primary-500/20 mb-3 inline-block uppercase tracking-wider">PROJECT: ${task.projectName || 'Active'}</span>` : '';

            const badgeBox = document.getElementById('task-status-badge');
            const map = { 'started':['Ù…Ù‡Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©','bg-slate-800 text-slate-400'], 'working':['Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°','bg-blue-500/20 text-blue-400'], 'review':['ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©','bg-purple-500/20 text-purple-400'], 'done':['Ù…ÙƒØªÙ…Ù„Ø© ÙˆÙ…Ø¹ØªÙ…Ø¯Ø©','bg-green-500/20 text-green-400'] };
            const m = map[task.status] || map['started'];
            badgeBox.innerHTML = `<span class="${m[1]} px-5 py-2 rounded-xl text-[11px] font-black border border-white/5 shadow-sm">${m[0]}</span>`;

            const fileBox = document.getElementById('task-files');
            fileBox.innerHTML = task.file ? `<div class="p-5 bg-dark-900 border border-white/5 rounded-3xl flex justify-between items-center"><div class="flex items-center gap-4"><div class="w-12 h-12 rounded-xl bg-red-500/10 text-red-500 flex items-center justify-center text-xl"><i class="fas fa-file-pdf"></i></div><div><p class="text-xs font-black text-slate-200">Ù…Ø±ÙÙ‚ Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ</p></div></div><a href="${task.file}" target="_blank" class="w-11 h-11 rounded-full bg-dark-800 flex items-center justify-center hover:bg-primary-600 transition"><i class="fas fa-download text-sm"></i></a></div>` : '';

            const actionBox = document.getElementById('task-action-controls');
            actionBox.innerHTML = '';
            if(!task.archived && task.status !== 'done') {
                if(task.status === 'started') actionBox.innerHTML += `<button onclick="updateTaskStep('${task.id}', 'working')" class="flex-1 py-4 bg-blue-600 rounded-2xl font-black text-sm shadow-xl shadow-blue-600/20"><i class="fas fa-play ml-2"></i> Ø¨Ø¯Ø¡ Ø§Ù„ØªÙ†ÙÙŠØ°</button>`;
                if(task.status === 'working') actionBox.innerHTML += `<button onclick="openQAModal('${task.id}')" class="flex-1 py-4 bg-purple-600 rounded-2xl font-black text-sm shadow-xl shadow-purple-600/20"><i class="fas fa-eye ml-2"></i> Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</button>`;
            } else if(task.status === 'done') {
                actionBox.innerHTML = `<div class="flex-1 py-4 bg-green-500/10 text-green-500 text-center rounded-2xl font-black text-sm border border-green-500/20">Ø§Ù„Ù…Ù‡Ù…Ø© Ù…ØºÙ„Ù‚Ø© âœ…</div>`;
            }
            renderComments(task.comments || []);
        }

        function renderComments(comments) {
            const box = document.getElementById('task-comments');
            box.innerHTML = '';
            comments.forEach(c => {
                const isMe = c.user === currentUser.email;
                if(c.user === 'system') box.innerHTML += `<div class="flex justify-center my-2"><span class="bg-dark-900 text-[9px] px-3 py-1 rounded-full text-slate-600 border border-white/5">${c.text}</span></div>`;
                else box.innerHTML += `<div class="flex gap-4 ${isMe ? 'flex-row-reverse' : ''} animate-fade-in"><img src="${DEFAULT_PHOTO+encodeURIComponent(c.name)}" class="w-10 h-10 rounded-xl shrink-0 border border-white/10 shadow-lg"><div class="max-w-[80%] flex flex-col ${isMe?'items-end':'items-start'}"><div class="bg-dark-900 border border-white/5 p-4 rounded-3xl ${isMe?'rounded-tl-none':'rounded-tr-none'}"><p class="text-xs text-slate-200">${c.text}</p>${c.file ? `<div class="mt-2 pt-2 border-t border-white/5"><a href="${c.file}" target="_blank" class="text-[9px] text-primary-500 font-bold">Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø±ÙÙ‚</a></div>` : ''}</div><span class="text-[9px] text-slate-600 mt-2">${c.name} â€¢ ${moment(c.time).fromNow()}</span></div></div>`;
            });
        }

        // 7. Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© (Chat) ÙˆØ§Ù„Ø²Ù…Ù„Ø§Ø¡
        function renderUsersDropdown() {
            const container = document.getElementById('users-list-content');
            if(!container) return;
            container.innerHTML = '';
            allUsers.filter(u => u.email !== currentUser.email).forEach(u => {
                const statusColor = u.status === 'Online' ? 'bg-green-500' : u.status === 'Break' ? 'bg-orange-500' : 'bg-slate-500';
                container.innerHTML += `
                    <div onclick="openPrivateChat('${u.email}', '${u.name}')" class="flex items-center gap-3 p-3 rounded-xl hover:bg-dark-900 transition cursor-pointer group">
                        <div class="relative shrink-0"><img src="${u.photo || DEFAULT_PHOTO + u.name}" class="w-9 h-9 rounded-xl object-cover"><span class="absolute -bottom-1 -right-1 w-3 h-3 rounded-full border-2 border-dark-800 ${statusColor}"></span></div>
                        <div class="overflow-hidden text-right flex-1"><p class="text-xs font-black truncate text-slate-200 group-hover:text-primary-500 transition">${u.name}</p><p class="text-[9px] font-bold text-slate-500 uppercase tracking-tighter">${u.title || 'Team Member'}</p></div>
                    </div>`;
            });
        }

        function initGlobalChat() {
            db.collection("messages").orderBy("time","asc").limitToLast(50).onSnapshot(s => {
                const t = document.getElementById("chat-messages");
                if(!t) return;
                t.innerHTML = "";
                s.forEach(d => {
                    const m = d.data(); const isMe = m.user === currentUser.email;
                    t.innerHTML += `<div class="flex ${isMe?'justify-end':'justify-start'} mb-3"><div class="max-w-[80%] ${isMe?'bg-primary-600 text-white rounded-tl-xl':'bg-dark-800 text-slate-200 rounded-tr-xl'} p-3 rounded-b-xl text-[11px] shadow-lg font-bold">${!isMe?`<p class="text-[9px] text-primary-400 mb-1">${m.name}</p>`:''}${m.text}</div></div>`;
                });
                t.scrollTop = t.scrollHeight;
            });
        }

        // 8. Ø³Ø¬Ù„ Ø§Ù„Ø­Ø±ÙƒØ§Øª Ø§Ù„Ù…Ø·ÙˆØ± (Logs)
        async function openLogsModal() {
            const container = document.getElementById('logs-timeline');
            container.innerHTML = '<div class="text-center py-10"><i class="fas fa-spinner fa-spin text-2xl text-primary-500"></i></div>';
            document.getElementById('modal-logs').classList.remove('hidden');
            const start = new Date(); start.setHours(0,0,0,0);
            const snap = await db.collection('logs').where('user', '==', currentUser.email.toLowerCase()).where('end_time', '>=', start).orderBy('end_time', 'desc').get();
            container.innerHTML = '';
            if(snap.empty) { container.innerHTML = '<p class="text-center text-slate-600">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø±ÙƒØ§Øª Ù…Ø³Ø¬Ù„Ø© Ù„Ù„ÙŠÙˆÙ…</p>'; return; }
            snap.forEach(doc => {
                const log = doc.data();
                container.innerHTML += `<div class="relative pb-6 border-r-2 border-white/5 pr-6"><div class="absolute -right-[9px] top-1 w-4 h-4 rounded-full bg-primary-500 border-4 border-dark-900 shadow-xl"></div><div class="bg-dark-900 p-4 rounded-2xl border border-white/5"><p class="text-[10px] font-black text-primary-500 mb-1">${moment(log.end_time.toDate()).format('hh:mm A')}</p><p class="text-xs font-bold text-slate-200 uppercase tracking-tight">ØªØ­ÙˆÙ„ Ù…Ù† <span class="text-slate-500">${log.from_status}</span> Ø¥Ù„Ù‰ <span class="text-green-500">${log.to_status}</span></p></div></div>`;
            });
        }

        // 9. Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ù„Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª
        async function handleStatusClick(newStatus) {
            if(userProfile.status === newStatus) return;
            await setStatus(currentUser.email.toLowerCase(), newStatus, false);
        }

        async function handleCommentSubmit(e) {
            e.preventDefault();
            const input = document.getElementById('comment-input');
            const txt = input.value.trim(); if(!txt && !attachedFileObj) return;
            document.getElementById('comment-btn').disabled = true;
            let url = await uploadFileToStorage(attachedFileObj, 'tasks/comments');
            const tasks = [...userProfile.tasks];
            const idx = tasks.findIndex(t => t.id == selectedTaskId);
            if(idx > -1) {
                tasks[idx].comments.push({ user: currentUser.email, name: userProfile.name, text: txt, file: url, time: Date.now() });
                await db.collection('users').doc(currentUser.email).update({ tasks });
                input.value = ''; attachedFileObj = null; document.getElementById('file-preview').classList.add('hidden');
            }
            document.getElementById('comment-btn').disabled = false;
        }

        async function handleGlobalMessage(e) {
            e.preventDefault();
            const i = document.getElementById("chat-input"); if(!i.value.trim()) return;
            await db.collection("messages").add({ text: i.value.trim(), user: currentUser.email, name: userProfile.name, time: firebase.firestore.FieldValue.serverTimestamp() });
            i.value = "";
        }

        function openQAModal(taskId) {
            document.getElementById('review-task-id').value = taskId;
            const sel = document.getElementById('qa-manager-select');
            sel.innerHTML = '';
            allUsers.filter(u => ['admin', 'supervisor', 'leader'].includes(u.role)).forEach(m => sel.innerHTML += `<option value="${m.email}">${m.name} (${m.role})</option>`);
            document.getElementById('modal-qa').classList.remove('hidden');
        }

        async function confirmQA() {
            const taskId = document.getElementById('review-task-id').value;
            const reviewer = document.getElementById('qa-manager-select').value;
            const tasks = [...userProfile.tasks];
            const idx = tasks.findIndex(t => t.id == taskId);
            if(idx > -1) {
                tasks[idx].status = 'review';
                tasks[idx].reviewerEmail = reviewer;
                tasks[idx].comments.push({ user: 'system', text: `Ø£ÙØ±Ø³Ù„Øª Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¹Ù†Ø¯: ${reviewer}`, time: Date.now() });
                await db.collection('users').doc(currentUser.email).update({ tasks });
                closeModal('modal-qa');
            }
        }

        async function updateTaskStep(id, status) {
            const tasks = [...userProfile.tasks];
            const idx = tasks.findIndex(t => t.id == id);
            if(idx > -1) {
                tasks[idx].status = status;
                tasks[idx].comments.push({ user: 'system', text: `ØªØºÙŠØ±Øª Ø§Ù„Ø­Ø§Ù„Ø© Ø¥Ù„Ù‰: ${status}`, time: Date.now() });
                await db.collection('users').doc(currentUser.email).update({ tasks });
            }
        }

        function startIdleTracker() {
            ['mousedown', 'mousemove', 'keydown', 'scroll', 'touchstart'].forEach(evt => {
                document.addEventListener(evt, () => {
                    lastActionTime = Date.now();
                    if(userProfile?.isIdle) db.collection('users').doc(currentUser.email).update({ isIdle: false, idleSince: null });
                }, true);
            });
            setInterval(() => {
                if(!userProfile || userProfile.status !== 'Online' || userProfile.isIdle) return;
                if(Date.now() - lastActionTime > (userProfile.idleLimit || 5) * 60000) db.collection('users').doc(currentUser.email).update({ isIdle: true, idleSince: firebase.firestore.FieldValue.serverTimestamp() });
            }, 10000);
        }

        function openPrivateChat(email, name) {
            document.getElementById('users-dropdown').classList.add('hidden');
            const chatId = [currentUser.email.toLowerCase(), email.toLowerCase()].sort().join("_").replace(/[@.]/g, "_");
            if(document.getElementById(`chat-win-${chatId}`)) return;
            const win = document.createElement('div');
            win.id = `chat-win-${chatId}`;
            win.className = "chat-window fixed bottom-10 left-10 w-72 h-[400px] bg-dark-900 border border-white/10 rounded-[2rem] shadow-2xl flex flex-col animate-fade-in";
            win.innerHTML = `<div class="p-4 border-b border-white/5 bg-dark-950 flex justify-between items-center chat-header rounded-t-[2rem] cursor-move"><span class="text-[10px] font-black uppercase text-primary-500 tracking-widest">${name}</span><button onclick="this.parentElement.parentElement.remove()" class="text-slate-500 hover:text-white"><i class="fas fa-times"></i></button></div><div id="msgs-${chatId}" class="flex-1 overflow-y-auto p-4 space-y-2 custom-scrollbar text-[11px]"></div><form onsubmit="sendPrivateMsg(event, '${email}', '${chatId}')" class="p-3 border-t border-white/5 flex gap-2"><input type="text" id="input-${chatId}" class="flex-1 bg-dark-950 border-none rounded-xl px-3 py-2 text-xs text-white" placeholder="Ø§ÙƒØªØ¨..." autocomplete="off"><button class="bg-primary-600 px-3 rounded-xl"><i class="fas fa-paper-plane text-[10px]"></i></button></form>`;
            document.getElementById('private-chats-container').appendChild(win);
            listenToPrivateChat(email, chatId);
        }
        async function sendPrivateMsg(e, email, chatId) { e.preventDefault(); const inp = document.getElementById(`input-${chatId}`); if(!inp.value.trim()) return; await db.collection('private_messages').add({ sender: currentUser.email.toLowerCase(), receiver: email.toLowerCase(), text: inp.value.trim(), time: firebase.firestore.FieldValue.serverTimestamp(), name: userProfile.name }); inp.value = ''; }
        function listenToPrivateChat(email, chatId) {
            const box = document.getElementById(`msgs-${chatId}`);
            db.collection('private_messages').orderBy('time', 'asc').onSnapshot(snap => {
                box.innerHTML = '';
                snap.docs.forEach(doc => {
                    const m = doc.data();
                    if((m.sender === currentUser.email.toLowerCase() && m.receiver === email.toLowerCase()) || (m.sender === email.toLowerCase() && m.receiver === currentUser.email.toLowerCase())) {
                        const isMe = m.sender === currentUser.email.toLowerCase();
                        box.innerHTML += `<div class="flex ${isMe?'justify-end':'justify-start'}"><span class="px-3 py-2 rounded-2xl ${isMe?'bg-primary-600 text-white rounded-tl-none':'bg-dark-800 text-slate-300 rounded-tr-none'} font-bold">${m.text}</span></div>`;
                    }
                });
                box.scrollTop = box.scrollHeight;
            });
        }

        function listenToPrivateMessages() {
            db.collection("private_messages").where("receiver", "==", currentUser.email.toLowerCase()).onSnapshot(s => {
                if(!s.metadata.hasPendingWrites) { s.docChanges().forEach(c => { if (c.type === "added") { document.getElementById("emp-chat-badge")?.classList.remove("hidden"); } }); }
            });
        }

        function handleFileSelect(input) { if(input.files[0]) { attachedFileObj = input.files[0]; document.getElementById('file-preview').innerText = "ğŸ“ Ø¬Ø§Ù‡Ø² Ù„Ù„Ø±ÙØ¹: " + attachedFileObj.name; document.getElementById('file-preview').classList.remove('hidden'); } }
        function toggleUsersDropdown() { document.getElementById('users-dropdown').classList.toggle('hidden'); document.getElementById('users-dropdown').classList.toggle('active'); }
        function changeTaskTab(mode, btn) { historyMode = mode; renderTasks(); document.querySelectorAll('.task-tab-btn').forEach(b => b.className = "task-tab-btn flex-1 py-2 text-[11px] font-black rounded-lg text-slate-500"); btn.className = "task-tab-btn flex-1 py-2 text-[11px] font-black rounded-lg bg-dark-800 text-white shadow-lg"; }
        function toggleChat() { document.getElementById('chat-window').classList.toggle('hidden'); document.getElementById('chat-badge').classList.add('hidden'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        async function logout() { if(confirm("ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ØŸ")) { await setStatus(currentUser.email, 'Offline', true); auth.signOut().then(() => window.location.replace('index.html')); } }
    </script>
</body>
</html>
