<!DOCTYPE html>
<html lang="ar" dir="rtl" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø³Ø§Ø­Ø© Ø¹Ù…Ù„ Ø§Ù„Ù…ÙˆØ¸Ù | ALMASTER</title>
    <meta name="theme-color" content="#020617">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&family=Outfit:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: { primary: { 500: '#0ea5e9', 600: '#0284c7' }, dark: { 800: '#1e293b', 900: '#0f172a', 950: '#020617' } },
                    fontFamily: { sans: ['Outfit', 'Cairo', 'sans-serif'] }
                }
            }
        }
    </script>

    <style>
        body { background-color: #020617; color: #f1f5f9; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        .hidden-section { display: none !important; }
        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 20px; }
        
        /* ØªØ£Ø«ÙŠØ± Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù†Ø´Ø·Ø© */
        .status-card-active { transform: scale(1.02); border-width: 2px; }
        .active-Online { background-color: #064e3b !important; border-color: #10b981 !important; }
        .active-Break { background-color: #78350f !important; border-color: #f59e0b !important; }
        .active-Meeting { background-color: #1e3a8a !important; border-color: #3b82f6 !important; }

        .task-card { background: #0f172a; border: 1px solid #1e293b; transition: all 0.2s; }
        .task-card:hover { border-color: #0ea5e9; background: #1e293b; }
        .task-card.active { border-right: 5px solid #0ea5e9; background: #1e293b; }

        /* Dropdown Ø§Ù„Ø²Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…Ø·ÙˆØ± */
        #users-dropdown { transform-origin: top; transition: all 0.2s ease-out; transform: scaleY(0); opacity: 0; }
        #users-dropdown.active { transform: scaleY(1); opacity: 1; }

        .chat-window { position: fixed; z-index: 100; display: flex; flex-direction: column; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .chat-header { cursor: move; user-select: none; }
    </style>
</head>

<body class="dark selection:bg-primary-500 selection:text-white">

    <div id="loader" class="fixed inset-0 z-[300] bg-dark-950 flex flex-col items-center justify-center">
        <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-primary-500 mb-4"></div>
        <h2 class="text-lg font-bold animate-pulse tracking-widest uppercase">Initializing Workspace</h2>
    </div>

    <main class="flex-1 flex overflow-hidden">
        
        <aside class="w-1/3 max-w-[400px] border-l border-white/5 flex flex-col bg-dark-950/80 backdrop-blur-md overflow-hidden h-full">
            
            <div class="p-6 border-b border-white/5 bg-dark-900 shrink-0">
                <div class="flex items-center justify-between mb-6">
                    <img src="MASTER_LOGO_WHPNG.png" class="h-7 object-contain" onerror="this.src='https://ui-avatars.com/api/?background=0ea5e9&color=fff&name=AL'">
                    <div class="flex items-center gap-2 text-[10px] font-bold text-green-500 bg-green-500/10 px-2 py-1 rounded-full border border-green-500/20">
                        <span class="w-1.5 h-1.5 rounded-full bg-green-500 animate-ping"></span> Live
                    </div>
                </div>

                <div class="flex items-center gap-4 mb-4">
                    <div class="relative">
                        <img id="user-img" src="" class="w-16 h-16 rounded-2xl object-cover border-2 border-primary-500 shadow-xl shadow-primary-500/20 bg-dark-800">
                        <span id="user-status-dot" class="absolute -bottom-1 -right-1 w-4 h-4 rounded-full border-2 border-dark-900 bg-slate-500"></span>
                    </div>
                    <div class="overflow-hidden">
                        <h2 id="user-name" class="font-black text-lg truncate">Loading...</h2>
                        <p id="user-role" class="text-[10px] text-slate-500 font-bold uppercase tracking-widest mb-2">Member</p>
                        <button onclick="viewLogs(currentUser.email)" class="text-[10px] font-black text-primary-500 hover:text-white transition uppercase flex items-center gap-2">
                            <i class="fas fa-history"></i> Ø¹Ø±Ø¶ Ø³Ø¬Ù„ Ø§Ù„Ø­Ø±ÙƒØ§Øª (History)
                        </button>
                    </div>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto custom-scrollbar p-6 space-y-4">
                <p class="text-[10px] font-black text-slate-500 uppercase tracking-widest mr-2">Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙˆØ­Ø§Ù„Ø© Ø§Ù„ÙŠÙˆÙ…:</p>
                
                <div class="grid grid-cols-1 gap-3">
                    <div id="card-Online" onclick="handleStatusClick('Online')" class="group cursor-pointer transition-all p-4 rounded-2xl border border-white/5 bg-dark-900 flex items-center justify-between hover:border-green-500/40">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-xl bg-green-500/10 text-green-500 flex items-center justify-center transition group-hover:scale-110"><i class="fas fa-laptop-code"></i></div>
                            <div><p class="text-[10px] font-black opacity-50 uppercase">ÙˆÙ‚Øª Ø§Ù„Ø¹Ù…Ù„</p><p id="timer-online" class="text-base font-black stat-timer" data-val="0" data-active="false" data-start="0">00:00:00</p></div>
                        </div>
                        <span class="text-[9px] font-black opacity-0 group-hover:opacity-100 transition text-green-400">Ø¨Ø¯Ø£ Ø§Ù„Ø¹Ù…Ù„</span>
                    </div>

                    <div id="card-Break" onclick="handleStatusClick('Break')" class="group cursor-pointer transition-all p-4 rounded-2xl border border-white/5 bg-dark-900 flex items-center justify-between hover:border-orange-500/40">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-xl bg-orange-500/10 text-orange-500 flex items-center justify-center transition group-hover:scale-110"><i class="fas fa-coffee"></i></div>
                            <div><p class="text-[10px] font-black opacity-50 uppercase">Ø§Ø³ØªØ±Ø§Ø­Ø©</p><p id="timer-break" class="text-base font-black stat-timer" data-val="0" data-active="false" data-start="0">00:00:00</p></div>
                        </div>
                        <span class="text-[9px] font-black opacity-0 group-hover:opacity-100 transition text-orange-400">ØªÙˆÙ‚Ù Ù…Ø¤Ù‚Øª</span>
                    </div>

                    <div id="card-Meeting" onclick="handleStatusClick('Meeting')" class="group cursor-pointer transition-all p-4 rounded-2xl border border-white/5 bg-dark-900 flex items-center justify-between hover:border-blue-500/40">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-xl bg-blue-500/10 text-blue-500 flex items-center justify-center transition group-hover:scale-110"><i class="fas fa-users"></i></div>
                            <div><p class="text-[10px] font-black opacity-50 uppercase">Ø§Ø¬ØªÙ…Ø§Ø¹</p><p id="timer-meeting" class="text-base font-black stat-timer" data-val="0" data-active="false" data-start="0">00:00:00</p></div>
                        </div>
                        <span class="text-[9px] font-black opacity-0 group-hover:opacity-100 transition text-blue-400">Ø¯Ø®ÙˆÙ„ Ø§Ø¬ØªÙ…Ø§Ø¹</span>
                    </div>
                </div>

                <div class="bg-red-500/5 border border-red-500/10 p-4 rounded-2xl flex items-center justify-between shrink-0">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 rounded-full bg-red-500/20 text-red-500 flex items-center justify-center animate-pulse"><i class="fas fa-keyboard"></i></div>
                        <div><p class="text-[10px] font-black text-red-400 opacity-60 uppercase">Ø§Ù„Ø®Ù…ÙˆÙ„ (Idle)</p><p id="timer-idle" class="text-lg font-black text-red-600 stat-idle" data-val="0" data-isidle="false" data-start="0">00:00:00</p></div>
                    </div>
                </div>

                <div class="pt-4 border-t border-white/5 space-y-3">
                    <p class="text-[10px] font-black text-slate-500 uppercase tracking-widest mr-2 mb-2">ØªÙˆØ§ØµÙ„ Ù…Ø¨Ø§Ø´Ø±:</p>
                    
                    <button onclick="toggleChat()" class="w-full py-4 bg-primary-600/10 text-primary-500 rounded-2xl border border-primary-500/20 font-black text-xs hover:bg-primary-600 hover:text-white transition flex items-center justify-center gap-3 relative">
                        <i class="fas fa-globe"></i> Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø¹Ø§Ù…Ø© (Group Chat)
                        <span id="chat-badge" class="absolute left-4 top-1/2 -translate-y-1/2 bg-red-500 text-white text-[10px] w-5 h-5 rounded-full flex items-center justify-center hidden border-2 border-dark-950">!</span>
                    </button>

                    <div class="relative mt-2">
                        <button onclick="toggleUsersDropdown()" class="w-full py-4 bg-dark-900 border border-white/10 rounded-2xl flex items-center justify-between px-5 hover:border-primary-500 transition">
                            <span class="text-xs font-black text-slate-300">ğŸ’¬ Ù…Ø­Ø§Ø¯Ø«Ø© Ø®Ø§ØµØ© (Ø§Ù„Ø²Ù…Ù„Ø§Ø¡)</span>
                            <i class="fas fa-chevron-down text-[10px] text-slate-500"></i>
                        </button>
                        <div id="users-dropdown" class="absolute bottom-full left-0 right-0 mb-2 bg-dark-800 border border-white/10 rounded-2xl shadow-2xl max-h-60 overflow-y-auto custom-scrollbar z-[60] hidden">
                            <div id="users-list-content" class="p-2 space-y-1">
                                </div>
                        </div>
                    </div>
                </div>
            </div>
        </aside>

        <section class="flex-1 flex overflow-hidden">
            
            <div class="w-80 border-l border-white/5 bg-dark-900 flex flex-col shrink-0">
                <div class="p-6 border-b border-white/5 bg-dark-950/50">
                    <h3 class="font-black text-lg flex items-center gap-3 mb-4"><i class="fas fa-tasks text-primary-500"></i> Ù…Ù‡Ø§Ù… Ø§Ù„Ø¹Ù…Ù„</h3>
                    <div class="flex p-1 bg-dark-950 rounded-xl border border-white/5">
                        <button onclick="changeTaskTab(false, this)" class="task-tab-btn flex-1 py-2 text-[11px] font-black rounded-lg bg-dark-800 text-white shadow-lg">Ø§Ù„Ø­Ø§Ù„ÙŠØ©</button>
                        <button onclick="changeTaskTab(true, this)" class="task-tab-btn flex-1 py-2 text-[11px] font-black rounded-lg text-slate-500 transition">Ø§Ù„Ø£Ø±Ø´ÙŠÙ</button>
                    </div>
                </div>
                <div id="task-list" class="flex-1 overflow-y-auto p-4 space-y-3 custom-scrollbar">
                    </div>
            </div>

            <div class="flex-1 bg-dark-950 flex flex-col relative overflow-hidden h-full">
                
                <div id="task-empty-state" class="flex-1 flex flex-col items-center justify-center text-slate-700 h-full">
                    <i class="fas fa-folder-open text-8xl mb-4 opacity-10"></i>
                    <p class="font-bold text-lg">Ø§Ø®ØªØ± Ù…Ù‡Ù…Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„ ÙˆØ§Ù„Ù…Ù„ÙØ§Øª</p>
                </div>

                <div id="task-content" class="hidden flex flex-col h-full">
                    <div class="flex-1 overflow-y-auto p-8 custom-scrollbar">
                        <div class="max-w-4xl mx-auto">
                            <div class="flex justify-between items-start mb-8">
                                <div>
                                    <div id="task-project-tag"></div>
                                    <h1 id="task-title" class="text-4xl font-black text-white mb-3">Task Title</h1>
                                    <div class="flex items-center gap-4 text-xs text-slate-500 bg-white/5 w-fit px-4 py-2 rounded-xl border border-white/5">
                                        <span><i class="far fa-calendar-alt text-primary-500 ml-1"></i> <span id="task-date"></span></span>
                                        <div class="w-1 h-1 rounded-full bg-slate-700"></div>
                                        <span><i class="fas fa-user-edit text-primary-500 ml-1"></i> Ø§Ù„Ø¥Ø³Ù†Ø§Ø¯: <span id="task-assigner" class="font-bold text-slate-300">Admin</span></span>
                                    </div>
                                </div>
                                <div id="task-status-badge"></div>
                            </div>
                            
                            <div id="task-desc" class="text-lg leading-relaxed text-slate-300 bg-white/5 p-8 rounded-3xl border border-white/5 mb-8"></div>
                            
                            <div id="task-files" class="grid grid-cols-1 gap-3 mb-10"></div>

                            <div class="space-y-6">
                                <h4 class="font-black text-sm border-r-4 border-primary-500 pr-3 text-slate-200">Ø§Ù„Ù…Ù†Ø§Ù‚Ø´Ø§Øª ÙˆØ§Ù„Ø±Ø¯ÙˆØ¯ Ø§Ù„Ø­ÙŠØ©</h4>
                                <div id="task-comments" class="space-y-4 pb-12"></div>
                            </div>
                        </div>
                    </div>

                    <div class="p-6 bg-dark-900 border-t border-white/5 flex flex-col gap-4 shrink-0">
                        <div id="task-action-controls" class="flex gap-3"></div>
                        <form onsubmit="sendComment(event)" class="flex gap-3 items-center bg-dark-950 p-2 rounded-2xl border border-white/10 shadow-inner">
                            <input type="file" id="comment-file" class="hidden" onchange="handleFileSelect(this)">
                            <button type="button" onclick="document.getElementById('comment-file').click()" class="w-12 h-11 rounded-xl hover:bg-white/5 text-slate-500 transition border border-transparent hover:border-white/5"><i class="fas fa-paperclip text-lg"></i></button>
                            <input type="text" id="comment-input" class="flex-1 bg-transparent border-none focus:ring-0 text-sm py-2 text-white" placeholder="Ø§ÙƒØªØ¨ Ø±Ø¯Ùƒ Ù‡Ù†Ø§..." autocomplete="off">
                            <button type="submit" id="comment-btn" class="w-14 h-11 bg-primary-600 rounded-xl hover:bg-primary-500 transition shadow-lg shadow-primary-500/20"><i class="fas fa-paper-plane"></i></button>
                        </form>
                        <div id="file-preview" class="hidden px-4 text-[10px] text-primary-500 font-bold animate-pulse"></div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <div id="chat-window" class="chat-window fixed top-20 left-10 w-[400px] h-[600px] bg-dark-900 border border-white/10 rounded-3xl overflow-hidden hidden animate-fade-in shadow-2xl">
        <div class="p-5 bg-dark-950 border-b border-white/5 flex justify-between items-center chat-header">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-primary-600 flex items-center justify-center text-white"><i class="fas fa-globe-africa"></i></div>
                <div><h3 class="font-black text-sm">Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø¹Ø§Ù…Ø©</h3><p class="text-[9px] text-slate-500 font-bold">ÙƒÙ„ Ø§Ù„Ø²Ù…Ù„Ø§Ø¡ Ù…ØªØµÙ„ÙˆÙ† Ù‡Ù†Ø§</p></div>
            </div>
            <button onclick="toggleChat()" class="w-8 h-8 rounded-full hover:bg-red-500/20 text-slate-500 hover:text-red-500 transition flex items-center justify-center"><i class="fas fa-times"></i></button>
        </div>
        <div id="chat-messages" class="flex-1 overflow-y-auto p-5 space-y-3 custom-scrollbar bg-dark-950/20"></div>
        <form onsubmit="sendMessage(event)" class="p-4 bg-dark-900 border-t border-white/5 flex gap-2">
            <input type="text" id="chat-input" class="flex-1 bg-dark-950 border border-white/5 rounded-xl px-4 py-2.5 text-xs text-white outline-none focus:border-primary-500" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø¬Ù…ÙŠØ¹..." autocomplete="off">
            <button type="submit" class="w-11 h-11 bg-primary-600 rounded-xl flex items-center justify-center hover:bg-primary-500 transition"><i class="fas fa-paper-plane text-sm"></i></button>
        </form>
    </div>

    <div id="private-chats-container"></div>

    <div id="modal-qa" class="fixed inset-0 z-[250] hidden bg-black/90 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-dark-900 w-full max-w-sm rounded-[2.5rem] p-8 border border-primary-500/20 shadow-2xl animate-fade-in">
            <div class="w-16 h-16 rounded-full bg-purple-500/20 text-purple-500 flex items-center justify-center mx-auto mb-6 text-2xl border border-purple-500/30"><i class="fas fa-eye"></i></div>
            <h3 class="text-xl font-black text-white mb-2 text-center uppercase tracking-tight">Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</h3>
            <p class="text-[11px] text-slate-400 mb-6 leading-relaxed text-center font-bold">ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ù„ÙŠØªÙ… Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù…Ø®Ø±Ø¬Ø§Øª ÙˆØ§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ù…Ù‡Ù…Ø© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ ÙÙŠ Ù†Ø³Ø¨Ø© Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„Ù…Ø´Ø±ÙˆØ¹.</p>
            <input type="hidden" id="review-task-id">
            <select id="qa-manager-select" class="form-input font-black mb-8 border-2 border-white/5 text-sm"></select>
            <div class="flex gap-2">
                <button onclick="confirmQA()" class="flex-1 bg-primary-600 py-4 rounded-2xl font-black shadow-lg shadow-primary-500/20 transition hover:bg-primary-500">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</button>
                <button onclick="closeModal('modal-qa')" class="px-6 py-4 bg-dark-800 rounded-2xl font-bold text-slate-400 hover:text-white transition">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <div id="modal-logs" class="fixed inset-0 z-[250] hidden bg-black/90 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-dark-900 w-full max-w-xl rounded-[2.5rem] flex flex-col max-h-[85vh] border border-white/5 shadow-2xl">
            <div class="p-6 border-b border-white/5 flex justify-between items-center bg-dark-950/50">
                <h3 class="font-black text-lg flex items-center gap-3"><i class="fas fa-history text-primary-500"></i> Ø³Ø¬Ù„ Ø­Ø±ÙƒØ§ØªÙŠ Ø§Ù„ÙŠÙˆÙ…</h3>
                <button onclick="closeModal('modal-logs')" class="text-slate-500 hover:text-white transition"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto p-6 custom-scrollbar relative">
                <div id="logs-timeline" class="relative border-r-2 border-white/5 mr-4 pr-6 space-y-6"></div>
                <div id="logs-loader" class="absolute inset-0 bg-dark-900/80 flex items-center justify-center hidden"><div class="animate-spin w-8 h-8 border-4 border-primary-500 border-t-transparent rounded-full"></div></div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. CONFIG & INIT ---
        const firebaseConfig = { apiKey: "AIzaSyCXyuT529aGwiS5j_RPxW_zEeAtkYc7JlM", authDomain: "almaster-b8c18.firebaseapp.com", projectId: "almaster-b8c18", storageBucket: "almaster-b8c18.firebasestorage.app", messagingSenderId: "884142036232", appId: "1:884142036232:web:eeb6677d988565653a08bd" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const storage = firebase.storage();

        let currentUser = null, userProfile = null, allUsers = [];
        let currentTasks = [], historyMode = false, selectedTaskId = null, attachedFileObj = null, lastActionTime = Date.now();
        const DEFAULT_PHOTO = 'https://ui-avatars.com/api/?background=0ea5e9&color=fff&bold=true&name=';

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                const doc = await db.collection('users').doc(user.email.toLowerCase()).get();
                if(doc.exists) {
                    userProfile = doc.data();
                    if (userProfile.role === 'admin') { window.location.replace('admin.html'); return; }
                    initWorkspace();
                } else { auth.signOut(); }
            } else { window.location.replace('index.html'); }
        });

        function initWorkspace() {
            startClock();
            startIdleTracker();
            listenToProfile();
            listenToAllUsers();
            initGlobalChat();
            listenToPrivateMessages();
            setInterval(updateTimersUI, 1000);
            document.getElementById('loader').classList.add('hidden');
        }

        // --- 2. LISTENERS ---
        function listenToProfile() {
            db.collection('users').doc(currentUser.email.toLowerCase()).onSnapshot(doc => {
                userProfile = doc.data();
                updateProfileUI(userProfile);
                currentTasks = userProfile.tasks || [];
                renderTasks();
                if(selectedTaskId) {
                    const task = currentTasks.find(t => t.id == selectedTaskId);
                    if(task) updateTaskDetail(task);
                }
            });
        }

        function listenToAllUsers() {
            db.collection('users').onSnapshot(snap => {
                allUsers = snap.docs.map(d => ({ email: d.id, ...d.data() }));
                renderUsersDropdown();
            });
        }

        // --- 3. UI RENDERERS ---
        function updateProfileUI(data) {
            document.getElementById('user-name').innerText = data.name;
            document.getElementById('user-role').innerText = data.title || (data.role === 'leader' ? 'Team Leader' : 'Team Member');
            document.getElementById('user-img').src = data.photo || DEFAULT_PHOTO + data.name;
            
            const status = data.status || 'Offline';
            const tb = data.timeBank || {};
            const safeStart = getMillis(data.lastChange);

            // Update Timers
            const timers = [
                { id: 'timer-online', val: tb['Online'] || 0, active: status === 'Online' },
                { id: 'timer-break', val: tb['Break'] || 0, active: status === 'Break' },
                { id: 'timer-meeting', val: tb['Meeting'] || 0, active: status === 'Meeting' }
            ];
            timers.forEach(t => {
                let el = document.getElementById(t.id);
                el.dataset.val = t.val; el.dataset.active = t.active; el.dataset.start = safeStart;
            });
            
            const idleEl = document.getElementById('timer-idle');
            idleEl.dataset.val = data.idleBank || 0; idleEl.dataset.isidle = data.isIdle; idleEl.dataset.start = getMillis(data.idleSince);

            // ğŸŸ¢ Update Card Styling ğŸŸ¢
            ['Online', 'Break', 'Meeting'].forEach(s => {
                const card = document.getElementById('card-' + s);
                card.classList.remove('status-card-active', 'active-Online', 'active-Break', 'active-Meeting');
                if(s === status) { card.classList.add('status-card-active', 'active-' + s); }
            });
            
            const dot = document.getElementById('user-status-dot');
            dot.className = `absolute -bottom-1 -right-1 w-4 h-4 rounded-full border-2 border-dark-900 ${status==='Online'?'bg-green-500':status==='Break'?'bg-orange-500':'bg-blue-500'}`;
        }

        function renderUsersDropdown() {
            const container = document.getElementById('users-list-content');
            container.innerHTML = '';
            allUsers.filter(u => u.email !== currentUser.email).forEach(u => {
                const statusColor = u.status === 'Online' ? 'bg-green-500' : u.status === 'Break' ? 'bg-orange-500' : 'bg-slate-500';
                container.innerHTML += `
                    <div onclick="openPrivateChat('${u.email}', '${u.name}')" class="flex items-center gap-3 p-3 rounded-xl hover:bg-dark-900 transition cursor-pointer group">
                        <div class="relative shrink-0">
                            <img src="${u.photo || DEFAULT_PHOTO + u.name}" class="w-9 h-9 rounded-xl object-cover">
                            <span class="absolute -bottom-1 -right-1 w-3 h-3 rounded-full border-2 border-dark-800 ${statusColor}"></span>
                        </div>
                        <div class="overflow-hidden">
                            <p class="text-xs font-black truncate text-slate-200 group-hover:text-primary-500 transition">${u.name}</p>
                            <p class="text-[9px] font-bold text-slate-500 uppercase tracking-tighter">${u.title || 'Team Member'}</p>
                        </div>
                    </div>
                `;
            });
        }

        function renderTasks() {
            const container = document.getElementById('task-list');
            container.innerHTML = '';
            const filtered = currentTasks.filter(t => historyMode ? t.archived : !t.archived);
            filtered.sort((a,b) => b.id - a.id);

            filtered.forEach(t => {
                const isActive = selectedTaskId == t.id;
                const card = document.createElement('div');
                card.className = `task-card p-4 rounded-2xl cursor-pointer ${isActive ? 'active' : ''}`;
                card.onclick = () => selectTask(t);
                
                let statusIcon = '<i class="fas fa-circle text-[8px] text-slate-700"></i>';
                if(t.status === 'working') statusIcon = '<i class="fas fa-spinner fa-spin text-[8px] text-blue-500"></i>';
                if(t.status === 'review') statusIcon = '<i class="fas fa-eye text-[8px] text-purple-500"></i>';
                if(t.status === 'done') statusIcon = '<i class="fas fa-check-circle text-[8px] text-green-500"></i>';

                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <h4 class="font-bold text-xs truncate w-44 text-slate-200">${t.title}</h4>
                        ${statusIcon}
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-[9px] font-bold text-slate-600">${moment(t.id).fromNow()}</span>
                        ${t.projectId ? `<span class="bg-indigo-500/10 text-indigo-400 text-[8px] px-2 py-0.5 rounded border border-indigo-500/20 font-black">ERP</span>` : ''}
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function selectTask(task) {
            selectedTaskId = task.id;
            renderTasks();
            document.getElementById('task-empty-state').classList.add('hidden');
            document.getElementById('task-content').classList.remove('hidden');
            updateTaskDetail(task);
        }

        function updateTaskDetail(task) {
            document.getElementById('task-title').innerText = task.title;
            document.getElementById('task-desc').innerHTML = task.desc;
            document.getElementById('task-date').innerText = moment(task.id).format('D MMMM YYYY, h:mm A');
            document.getElementById('task-assigner').innerText = task.createdBy || "Admin";

            const tagBox = document.getElementById('task-project-tag');
            tagBox.innerHTML = task.projectId ? `<span class="bg-primary-600/10 text-primary-500 text-[10px] font-black px-4 py-1.5 rounded-full border border-primary-500/20 mb-3 inline-block uppercase tracking-wider">Project: ${task.projectName || 'Active'}</span>` : '';

            const badgeBox = document.getElementById('task-status-badge');
            const map = { 'started':['Ù…Ù‡Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©','bg-slate-800 text-slate-400'], 'working':['Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°','bg-blue-500/20 text-blue-400'], 'review':['ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©','bg-purple-500/20 text-purple-400'], 'done':['Ù…ÙƒØªÙ…Ù„Ø© ÙˆÙ…Ø¹ØªÙ…Ø¯Ø©','bg-green-500/20 text-green-400'] };
            const m = map[task.status] || map['started'];
            badgeBox.innerHTML = `<span class="${m[1]} px-5 py-2 rounded-xl text-[11px] font-black border border-white/5 shadow-sm">${m[0]}</span>`;

            const fileBox = document.getElementById('task-files');
            fileBox.innerHTML = task.file ? `<div class="p-5 bg-dark-900 border border-white/5 rounded-3xl flex justify-between items-center"><div class="flex items-center gap-4"><div class="w-12 h-12 rounded-xl bg-red-500/10 text-red-500 flex items-center justify-center text-xl"><i class="fas fa-file-pdf"></i></div><div><p class="text-xs font-black text-slate-200">Ù…Ø±ÙÙ‚ Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ</p><p class="text-[10px] text-slate-500">Ø§Ø¶ØºØ· Ù„Ù„ØªØ­Ù…ÙŠÙ„ Ø£Ùˆ Ø§Ù„Ø¹Ø±Ø¶</p></div></div><a href="${task.file}" target="_blank" class="w-11 h-11 rounded-full bg-dark-800 flex items-center justify-center hover:bg-primary-600 transition shadow-lg"><i class="fas fa-download text-sm"></i></a></div>` : '';

            const actionBox = document.getElementById('task-action-controls');
            actionBox.innerHTML = '';
            if(!task.archived && task.status !== 'done') {
                if(task.status === 'started') actionBox.innerHTML += `<button onclick="updateTaskStep('${task.id}', 'working')" class="flex-1 py-4 bg-blue-600 rounded-2xl font-black text-sm transition transform active:scale-95 shadow-xl shadow-blue-600/20"><i class="fas fa-play ml-2"></i> Ø¨Ø¯Ø¡ Ø§Ù„ØªÙ†ÙÙŠØ° Ø§Ù„Ø¢Ù†</button>`;
                if(task.status === 'working') actionBox.innerHTML += `<button onclick="openQAModal('${task.id}')" class="flex-1 py-4 bg-purple-600 rounded-2xl font-black text-sm transition transform active:scale-95 shadow-xl shadow-purple-600/20"><i class="fas fa-eye ml-2"></i> Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© ÙˆØ§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯</button>`;
                if(task.status === 'review') actionBox.innerHTML += `<div class="flex-1 py-4 bg-dark-800 text-slate-500 text-center rounded-2xl font-black text-xs border border-white/5 animate-pulse">Ù‚ÙŠØ¯ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¬ÙˆØ¯Ø© Ø­Ø§Ù„ÙŠØ§Ù‹...</div>`;
            } else if(task.status === 'done') {
                actionBox.innerHTML = `<div class="flex-1 py-4 bg-green-500/10 text-green-500 text-center rounded-2xl font-black text-sm border border-green-500/20">Ø§Ù„Ù…Ù‡Ù…Ø© Ù…ÙƒØªÙ…Ù„Ø© ÙˆÙ…ØºÙ„Ù‚Ø© âœ…</div>`;
            }

            renderComments(task.comments || []);
        }

        function renderComments(comments) {
            const box = document.getElementById('task-comments');
            box.innerHTML = '';
            comments.forEach(c => {
                const isMe = c.user === currentUser.email;
                if(c.user === 'system') {
                    box.innerHTML += `<div class="flex justify-center"><span class="bg-dark-900 text-[10px] px-4 py-1.5 rounded-full text-slate-500 border border-white/5 font-bold">${c.text}</span></div>`;
                } else {
                    box.innerHTML += `
                        <div class="flex gap-4 ${isMe ? 'flex-row-reverse' : ''} animate-fade-in">
                            <img src="${DEFAULT_PHOTO + encodeURIComponent(c.name)}" class="w-10 h-10 rounded-xl shrink-0 object-cover border border-white/10 shadow-lg">
                            <div class="max-w-[80%] flex flex-col ${isMe?'items-end':'items-start'}">
                                <div class="bg-dark-900 border border-white/5 p-4 rounded-[1.5rem] ${isMe?'rounded-tl-none':'rounded-tr-none'} shadow-sm">
                                    <p class="text-xs text-slate-200 leading-relaxed">${c.text}</p>
                                    ${c.file ? `<div class="mt-3 pt-3 border-t border-white/5"><a href="${c.file}" target="_blank" class="text-[10px] font-black text-primary-500 flex items-center gap-2 hover:underline"><i class="fas fa-paperclip"></i> Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø±ÙÙ‚</a></div>` : ''}
                                </div>
                                <span class="text-[9px] text-slate-600 mt-2 font-black">${c.name} â€¢ ${moment(c.time).fromNow()}</span>
                            </div>
                        </div>`;
                }
            });
        }

        // --- 4. ACTIONS & CORE LOGIC ---
        async function handleStatusClick(newStatus) {
            if(userProfile.status === newStatus) return;
            const loader = document.getElementById('loader');
            loader.classList.remove('hidden');
            await setStatus(currentUser.email.toLowerCase(), newStatus, false);
            loader.classList.add('hidden');
        }

        async function setStatus(targetEmail, newStatus, isAuto = false) {
            const userRef = db.collection('users').doc(targetEmail);
            const snapshot = await userRef.get();
            const uData = snapshot.data();
            const now = Date.now();
            let currentIdleBank = uData.idleBank || 0;
            
            if (uData.isIdle && uData.idleSince) {
                const dur = now - getMillis(uData.idleSince);
                currentIdleBank += dur;
                await db.collection('logs').add({ user: targetEmail, name: uData.name, from_status: 'Idle (Auto)', to_status: newStatus, start_time: uData.idleSince, end_time: firebase.firestore.FieldValue.serverTimestamp(), duration_ms: dur, auto: true });
            }

            const lastTime = getMillis(uData.lastChange);
            const duration = now - lastTime;
            let timeBank = uData.timeBank || {};
            const oldStatus = uData.status || 'Offline';
            
            if(!timeBank[oldStatus]) timeBank[oldStatus] = 0;
            timeBank[oldStatus] += duration;
            const timestamp = firebase.firestore.FieldValue.serverTimestamp();

            await db.collection('logs').add({ user: targetEmail, name: uData.name, from_status: oldStatus, to_status: newStatus, start_time: uData.lastChange || timestamp, end_time: timestamp, duration_ms: duration, auto: isAuto });
            await userRef.update({ status: newStatus, lastChange: timestamp, timeBank: timeBank, isIdle: false, idleSince: null, idleBank: currentIdleBank });
        }

        async function updateTaskStep(taskId, status) {
            const userRef = db.collection('users').doc(currentUser.email);
            let tasks = [...userProfile.tasks];
            const idx = tasks.findIndex(t => t.id == taskId);
            if(idx > -1) {
                tasks[idx].status = status;
                tasks[idx].comments = tasks[idx].comments || [];
                tasks[idx].comments.push({ user: 'system', text: `Ù‚Ø§Ù… Ø§Ù„Ù…ÙˆØ¸Ù Ø¨ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø© Ø¥Ù„Ù‰: ${status}`, time: Date.now() });
                await userRef.update({ tasks });
            }
        }

        function openQAModal(taskId) {
            document.getElementById('review-task-id').value = taskId;
            const sel = document.getElementById('qa-manager-select');
            sel.innerHTML = '';
            allUsers.filter(u => ['admin', 'supervisor', 'leader'].includes(u.role)).forEach(m => {
                sel.innerHTML += `<option value="${m.email}">${m.name} (${m.role})</option>`;
            });
            openModal('modal-qa');
        }

        async function confirmQA() {
            const taskId = document.getElementById('review-task-id').value;
            const reviewer = document.getElementById('qa-manager-select').value;
            const userRef = db.collection('users').doc(currentUser.email);
            let tasks = [...userProfile.tasks];
            const idx = tasks.findIndex(t => t.id == taskId);
            if(idx > -1) {
                tasks[idx].status = 'review';
                tasks[idx].reviewerEmail = reviewer;
                tasks[idx].comments.push({ user: 'system', text: `Ø£Ø±Ø³Ù„ Ø§Ù„Ù…Ù‡Ù…Ø© Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¹Ù†Ø¯: ${reviewer}`, time: Date.now() });
                await userRef.update({ tasks });
                closeModal('modal-qa');
                alert("ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¨Ù†Ø¬Ø§Ø­.");
            }
        }

        async function sendComment(e) {
            e.preventDefault();
            const input = document.getElementById('comment-input');
            const txt = input.value.trim();
            if(!txt && !attachedFileObj) return;

            const btn = document.getElementById('comment-btn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            let fileUrl = null;
            if(attachedFileObj) { fileUrl = await uploadFileToStorage(attachedFileObj, 'tasks/comments'); }

            const userRef = db.collection('users').doc(currentUser.email);
            let tasks = [...userProfile.tasks];
            const idx = tasks.findIndex(t => t.id == selectedTaskId);
            if(idx > -1) {
                tasks[idx].comments = tasks[idx].comments || [];
                tasks[idx].comments.push({ user: currentUser.email, name: userProfile.name, text: txt, file: fileUrl, time: Date.now() });
                await userRef.update({ tasks });
                input.value = '';
                attachedFileObj = null;
                document.getElementById('file-preview').classList.add('hidden');
            }
            btn.disabled = false; btn.innerHTML = '<i class="fas fa-paper-plane"></i>';
        }

        // --- 5. HELPERS & UTILS ---
        async function uploadFileToStorage(file, path) {
            const ref = storage.ref().child(`${path}/${Date.now()}_${file.name}`);
            await ref.put(file);
            return await ref.getDownloadURL();
        }

        function updateTimersUI() {
            const now = Date.now();
            document.querySelectorAll('.stat-timer').forEach(t => { 
                const b = parseInt(t.dataset.val)||0; const s = parseInt(t.dataset.start)||0; 
                t.innerText = formatDurationLong((t.dataset.active==='true')?b+(now-s):b); 
            });
            document.querySelectorAll('.stat-idle').forEach(t => { 
                const b = parseInt(t.dataset.val)||0; const s = parseInt(t.dataset.start)||0; 
                t.innerText = formatDurationLong((t.dataset.isidle==='true')?b+(now-s):b); 
            });
        }

        function formatDurationLong(ms) {
            if(ms < 0) ms = 0;
            const s = Math.floor((ms/1000)%60).toString().padStart(2,'0');
            const m = Math.floor((ms/1000/60)%60).toString().padStart(2,'0');
            const h = Math.floor((ms/1000/60/60)).toString().padStart(2,'0');
            return `${h}:${m}:${s}`;
        }

        function getMillis(v) { return v ? (v.toMillis ? v.toMillis() : v) : Date.now(); }

        function startIdleTracker() {
            ['mousedown', 'mousemove', 'keydown', 'scroll', 'touchstart'].forEach(evt => {
                document.addEventListener(evt, () => {
                    lastActionTime = Date.now();
                    if(userProfile?.isIdle) { db.collection('users').doc(currentUser.email).update({ isIdle: false, idleSince: null }); }
                }, true);
            });
            setInterval(() => {
                if(!userProfile || userProfile.status !== 'Online' || userProfile.isIdle) return;
                if(Date.now() - lastActionTime > (userProfile.idleLimit || 5) * 60000) {
                    db.collection('users').doc(currentUser.email).update({ isIdle: true, idleSince: firebase.firestore.FieldValue.serverTimestamp() });
                }
            }, 10000);
        }

        function changeTaskTab(mode, btn) {
            historyMode = mode;
            renderTasks();
            document.querySelectorAll('.task-tab-btn').forEach(b => b.className = "task-tab-btn flex-1 py-2 text-[11px] font-black rounded-lg text-slate-500 transition");
            btn.className = "task-tab-btn flex-1 py-2 text-[11px] font-black rounded-lg bg-dark-800 text-white shadow-lg";
        }

        function handleFileSelect(input) {
            if(input.files && input.files[0]) {
                attachedFileObj = input.files[0];
                document.getElementById('file-preview').innerText = "ğŸ“ Ø¬Ø§Ù‡Ø² Ù„Ù„Ø±ÙØ¹: " + attachedFileObj.name;
                document.getElementById('file-preview').classList.remove('hidden');
            }
        }

        async function viewLogs(email) {
            openModal('modal-logs');
            const container = document.getElementById('logs-timeline');
            const loader = document.getElementById('logs-loader');
            container.innerHTML = ''; loader.classList.remove('hidden');

            const start = new Date(); start.setHours(0,0,0,0);
            const snap = await db.collection('logs').where('user', '==', email).where('end_time', '>=', start).orderBy('end_time', 'desc').get();
            
            loader.classList.add('hidden');
            if(snap.empty) { container.innerHTML = '<p class="text-center text-xs text-slate-600">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø±ÙƒØ§Øª Ù…Ø³Ø¬Ù„Ø© Ù„Ù„ÙŠÙˆÙ…</p>'; return; }

            snap.forEach(doc => {
                const log = doc.data();
                container.innerHTML += `
                    <div class="relative pb-2">
                        <div class="absolute -right-[27px] top-1 w-3 h-3 rounded-full bg-primary-500 border-2 border-dark-900"></div>
                        <div class="bg-white/5 p-3 rounded-2xl border border-white/5">
                            <p class="text-[10px] font-black text-primary-500 mb-1">${moment(log.end_time.toDate()).format('hh:mm A')}</p>
                            <p class="text-xs font-bold text-slate-200">ØªØ­ÙˆÙ„ Ù…Ù† <span class="text-slate-500">${log.from_status}</span> Ø¥Ù„Ù‰ <span class="text-green-500">${log.to_status}</span></p>
                        </div>
                    </div>`;
            });
        }

        function toggleUsersDropdown() { document.getElementById('users-dropdown').classList.toggle('hidden'); document.getElementById('users-dropdown').classList.toggle('active'); }
        function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function toggleChat() { document.getElementById('chat-window').classList.toggle('hidden'); document.getElementById('chat-badge').classList.add('hidden'); document.getElementById('emp-chat-badge').classList.add('hidden'); makeDraggable(document.getElementById('chat-window')); }

        async function logout() {
            if(!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ")) return;
            await setStatus(currentUser.email, 'Offline', true);
            auth.signOut().then(() => window.location.replace('index.html'));
        }

        // --- CHAT LOGIC ---
        function initGlobalChat() {
            db.collection("messages").orderBy("time","asc").limitToLast(50).onSnapshot(s=>{
                const t=document.getElementById("chat-messages"); 
                let isNew = false;
                s.docChanges().forEach(change => { if(change.type === "added") isNew = true; });
                t.innerHTML="";
                s.forEach(d=>{ 
                    const m=d.data(); const isMe=m.user===currentUser.email;
                    t.innerHTML += `<div class="flex ${isMe?'justify-end':'justify-start'} mb-2"><div class="max-w-[80%] ${isMe?'bg-primary-600 text-white rounded-tl-xl':'bg-dark-800 text-slate-200 rounded-tr-xl'} p-3 rounded-b-xl text-[11px] font-bold shadow-sm">${!isMe?`<p class="text-[9px] text-primary-400 mb-1">${m.name}</p>`:''}${m.text}</div></div>`;
                });
                t.scrollTop = t.scrollHeight;
                if(isNew && document.getElementById("chat-window").classList.contains("hidden")) { document.getElementById("chat-badge").classList.remove("hidden"); }
            });
        }

        async function sendMessage(e) {
            e.preventDefault();
            const i = document.getElementById("chat-input");
            if(!i.value.trim()) return;
            await db.collection("messages").add({ text: i.value.trim(), user: currentUser.email, name: userProfile.name, time: firebase.firestore.FieldValue.serverTimestamp() });
            i.value = "";
        }

        function openPrivateChat(email, name) {
            toggleUsersDropdown();
            const chatId = [currentUser.email.toLowerCase(), email.toLowerCase()].sort().join("_").replace(/[@.]/g, "_");
            if(document.getElementById(`chat-win-${chatId}`)) return;

            const win = document.createElement('div');
            win.id = `chat-win-${chatId}`;
            win.className = "chat-window fixed bottom-10 left-10 w-72 h-[450px] bg-dark-900 border border-white/10 rounded-[2rem] shadow-2xl flex flex-col animate-fade-in";
            win.innerHTML = `
                <div class="p-4 border-b border-white/5 bg-dark-950 flex justify-between items-center chat-header rounded-t-[2rem]">
                    <div class="flex items-center gap-2"><img src="${DEFAULT_PHOTO+name}" class="w-6 h-6 rounded-lg"><span class="text-[10px] font-black text-primary-500 uppercase tracking-widest">${name}</span></div>
                    <button onclick="this.parentElement.parentElement.remove()" class="text-slate-500 hover:text-white transition"><i class="fas fa-times text-xs"></i></button>
                </div>
                <div id="msgs-${chatId}" class="flex-1 overflow-y-auto p-4 space-y-2 custom-scrollbar text-[11px]"></div>
                <form onsubmit="sendPrivateMsg(event, '${email}', '${chatId}')" class="p-3 border-t border-white/5 flex gap-2">
                    <input type="text" id="input-${chatId}" class="flex-1 bg-dark-950 border-none rounded-xl px-3 py-2 text-xs text-white" placeholder="Ø§ÙƒØªØ¨..." autocomplete="off">
                    <button class="bg-primary-600 px-3 rounded-xl"><i class="fas fa-paper-plane text-[10px]"></i></button>
                </form>
            `;
            document.getElementById('private-chats-container').appendChild(win);
            makeDraggable(win);
            listenToPrivateChat(email, chatId);
        }

        async function sendPrivateMsg(e, email, chatId) {
            e.preventDefault();
            const input = document.getElementById(`input-${chatId}`);
            if(!input.value.trim()) return;
            await db.collection('private_messages').add({ sender: currentUser.email.toLowerCase(), receiver: email.toLowerCase(), text: input.value.trim(), time: firebase.firestore.FieldValue.serverTimestamp(), name: userProfile.name });
            input.value = '';
        }

        function listenToPrivateChat(email, chatId) {
            const container = document.getElementById(`msgs-${chatId}`);
            db.collection('private_messages').orderBy('time', 'asc').onSnapshot(snap => {
                container.innerHTML = '';
                snap.docs.forEach(doc => {
                    const m = doc.data();
                    const isMe = m.sender === currentUser.email.toLowerCase();
                    const isThem = m.sender === email.toLowerCase();
                    const isRecMe = m.receiver === currentUser.email.toLowerCase();
                    const isRecThem = m.receiver === email.toLowerCase();
                    if((isMe && isRecThem) || (isThem && isRecMe)) {
                        container.innerHTML += `<div class="flex ${isMe?'justify-end':'justify-start'}"><span class="px-3 py-2 rounded-2xl font-bold ${isMe?'bg-primary-600 text-white rounded-tl-none':'bg-dark-800 text-slate-300 rounded-tr-none'}">${m.text}</span></div>`;
                    }
                });
                container.scrollTop = container.scrollHeight;
            });
        }
        
        function makeDraggable(el) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            const header = el.querySelector('.chat-header');
            if(header) {
                header.onmousedown = (e) => { e.preventDefault(); pos3 = e.clientX; pos4 = e.clientY; document.onmouseup = () => { document.onmouseup = null; document.onmousemove = null; }; document.onmousemove = (e) => { e.preventDefault(); pos1 = pos3 - e.clientX; pos2 = pos4 - e.clientY; pos3 = e.clientX; pos4 = e.clientY; el.style.top = (el.offsetTop - pos2) + "px"; el.style.left = (el.offsetLeft - pos1) + "px"; }; };
            }
        }
    </script>
</body>
</html>
