<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ALMASTER ERP & CRM</title>
    <meta name="theme-color" content="#0ea5e9">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&family=Outfit:wght@300;400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: { 50: '#f0f9ff', 100: '#e0f2fe', 500: '#0ea5e9', 600: '#0284c7', 700: '#0369a1', 900: '#0c4a6e' },
                        dark: { 800: '#1e293b', 900: '#0f172a' }
                    },
                    fontFamily: { sans: ['Cairo', 'Outfit', 'sans-serif'] }
                }
            }
        }
    </script>

    <style>
        body { background-color: #f8fafc; font-family: 'Cairo', sans-serif; overflow-x: hidden; }
        .dark-mode body { background-color: #0f172a; color: #f1f5f9; }
        .hidden-view { display: none !important; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 10px; }
        .glass-card { background: white; border: 1px solid #e2e8f0; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
        .dark-mode .glass-card { background: #1e293b; border-color: #334155; }
        .form-input { width: 100%; padding: 10px 14px; border-radius: 0.75rem; border: 1px solid #cbd5e1; background: #f8fafc; font-size: 13px; font-weight: 600; transition: all 0.2s; }
        .form-input:focus { border-color: #0ea5e9; outline: none; background: white; }
        .dark-mode .form-input { background: #0f172a; border-color: #475569; color: white; }
        .nav-item.active { background-color: #f0f9ff; color: #0284c7; border-right: 4px solid #0ea5e9; }
        .dark-mode .nav-item.active { background-color: #0c4a6e; color: #38bdf8; }
        
        /* Kanban Columns */
        .kanban-col { min-height: 500px; background: #f1f5f9; border-radius: 1rem; padding: 1rem; }
        .dark-mode .kanban-col { background: #1e293b; }
        .kanban-card { background: white; padding: 1rem; border-radius: 0.75rem; margin-bottom: 0.75rem; border: 1px solid #e2e8f0; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .dark-mode .kanban-card { background: #0f172a; border-color: #334155; }
    </style>
</head>

<body class="flex h-screen text-slate-800 antialiased">

    <div id="loader" class="fixed inset-0 z-[200] bg-white dark:bg-slate-900 flex flex-col items-center justify-center">
        <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-primary-500 mb-4"></div>
        <h2 class="text-lg font-bold">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø§Ù„ÙŠ...</h2>
    </div>

    <aside class="w-64 bg-white dark:bg-slate-800 border-l border-slate-200 dark:border-slate-700 flex flex-col shadow-lg z-20 hidden md:flex">
        <div class="h-20 flex items-center justify-center border-b border-slate-100 dark:border-slate-700">
            <h1 class="text-2xl font-black text-primary-600 tracking-tight">ALMASTER <span class="text-slate-800 dark:text-white text-sm">ERP</span></h1>
        </div>
        
        <nav class="flex-1 py-4 px-3 space-y-1 custom-scrollbar overflow-y-auto">
            <button onclick="switchView('dashboard')" id="nav-dashboard" class="nav-item active w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-bold text-slate-600 transition"><i class="fas fa-chart-pie w-5"></i> Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</button>
            <button onclick="switchView('clients')" id="nav-clients" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-bold text-slate-600 transition"><i class="fas fa-users w-5"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</button>
            <button onclick="switchView('projects')" id="nav-projects" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-bold text-slate-600 transition"><i class="fas fa-project-diagram w-5"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</button>
            <button onclick="switchView('financials')" id="nav-financials" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-bold text-slate-600 transition"><i class="fas fa-file-invoice-dollar w-5"></i> Ø§Ù„ÙÙˆØ§ØªÙŠØ± ÙˆØ§Ù„Ù…ØµØ±ÙˆÙØ§Øª</button>
            <button onclick="switchView('collections')" id="nav-collections" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-bold text-slate-600 transition"><i class="fas fa-hand-holding-dollar w-5"></i> Ø§Ù„ØªØ­ØµÙŠÙ„ ÙˆØ§Ù„Ù…ØªØ£Ø®Ø±Ø§Øª</button>
            <button onclick="switchView('reports')" id="nav-reports" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-bold text-slate-600 transition"><i class="fas fa-chart-line w-5"></i> Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø´Ø§Ù…Ù„Ø©</button>
            
            <div class="mt-6 pt-4 border-t border-slate-200 dark:border-slate-700">
                <button onclick="window.location.href='index.html'" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-bold text-white bg-slate-800 hover:bg-slate-900 transition shadow-md"><i class="fas fa-desktop w-5"></i> Ø³ÙŠØ³ØªÙ… Ø§Ù„ØªØ´ØºÙŠÙ„</button>
            </div>
        </nav>

        <div class="p-4 border-t border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-900">
            <div class="flex items-center gap-3">
                <img id="sidebar-user-img" src="" class="w-10 h-10 rounded-full border-2 border-primary-500 object-cover">
                <div class="overflow-hidden">
                    <p id="sidebar-user-name" class="text-sm font-black dark:text-white truncate">User</p>
                    <p id="sidebar-user-role" class="text-[10px] text-primary-500 font-bold uppercase">Role</p>
                </div>
            </div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-screen overflow-hidden bg-slate-50 dark:bg-[#0f172a]">
        <header class="h-20 bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 px-6 flex items-center justify-between z-10">
            <h2 id="page-title" class="text-xl font-black text-slate-800 dark:text-white">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h2>
            <button onclick="toggleDarkMode()" class="w-10 h-10 rounded-full bg-slate-100 dark:bg-slate-700 text-slate-500 hover:text-primary-600 transition"><i class="fas fa-moon"></i></button>
        </header>

        <div class="flex-1 overflow-y-auto custom-scrollbar p-6">
            
            <div id="view-dashboard" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="glass-card p-5 border-b-4 border-blue-500"><p class="text-xs font-bold text-slate-500">Ù…Ø´Ø§Ø±ÙŠØ¹ Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</p><h3 id="dash-projects" class="text-3xl font-black mt-1">0</h3></div>
                    <div class="glass-card p-5 border-b-4 border-green-500"><p class="text-xs font-bold text-slate-500">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ¹Ø§Ù‚Ø¯Ø§Øª</p><h3 id="dash-revenue" class="text-2xl font-black text-green-600 mt-1">0 <span class="text-sm">Ø±.Ø³</span></h3></div>
                    <div class="glass-card p-5 border-b-4 border-red-500"><p class="text-xs font-bold text-slate-500">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</p><h3 id="dash-expenses" class="text-2xl font-black text-red-500 mt-1">0 <span class="text-sm">Ø±.Ø³</span></h3></div>
                    <div class="glass-card p-5 border-b-4 border-primary-500"><p class="text-xs font-bold text-slate-500">ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠ</p><h3 id="dash-profit" class="text-2xl font-black text-primary-600 mt-1">0 <span class="text-sm">Ø±.Ø³</span></h3></div>
                </div>
            </div>

            <div id="view-clients" class="hidden-view space-y-4">
                <div class="flex justify-between items-center bg-white dark:bg-slate-800 p-4 rounded-xl border border-slate-200 dark:border-slate-700">
                    <h3 class="font-bold">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ (CRM)</h3>
                    <button onclick="openModal('modal-client')" class="bg-primary-600 text-white px-4 py-2 rounded-lg font-bold text-sm"><i class="fas fa-plus"></i> Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="kanban-col"><h4 class="font-black mb-4 text-yellow-600 border-b-2 border-yellow-200 pb-2">ğŸ¯ Ù…Ø­ØªÙ…Ù„ (Leads)</h4><div id="kb-leads" class="space-y-3"></div></div>
                    <div class="kanban-col"><h4 class="font-black mb-4 text-green-600 border-b-2 border-green-200 pb-2">ğŸ¤ Ù†Ø´Ø· (Active)</h4><div id="kb-active" class="space-y-3"></div></div>
                    <div class="kanban-col"><h4 class="font-black mb-4 text-slate-600 border-b-2 border-slate-200 pb-2">ğŸ“¦ Ø¹Ù…Ù„Ø§Ø¡ Ø³Ø§Ø¨Ù‚ÙŠÙ†</h4><div id="kb-old" class="space-y-3"></div></div>
                    <div class="kanban-col"><h4 class="font-black mb-4 text-red-600 border-b-2 border-red-200 pb-2">ğŸš« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙˆØ¯Ø§Ø¡</h4><div id="kb-blacklist" class="space-y-3"></div></div>
                </div>
            </div>

            <div id="view-projects" class="hidden-view space-y-4">
                <div class="flex justify-between items-center bg-white dark:bg-slate-800 p-4 rounded-xl border border-slate-200 dark:border-slate-700">
                    <h3 class="font-bold">Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ ÙˆØ§Ù„Ø±Ø¨Ø­ÙŠØ©</h3>
                    <button onclick="openModal('modal-project')" class="bg-primary-600 text-white px-4 py-2 rounded-lg font-bold text-sm"><i class="fas fa-folder-plus"></i> Ù…Ø´Ø±ÙˆØ¹ Ø¬Ø¯ÙŠØ¯</button>
                </div>
                <div class="grid grid-cols-1 gap-4" id="projects-list"></div>
            </div>

            <div id="view-financials" class="hidden-view space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="glass-card p-5">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-black text-green-600"><i class="fas fa-file-invoice"></i> Ø§Ù„ÙÙˆØ§ØªÙŠØ± (Ø¥ÙŠØ±Ø§Ø¯Ø§Øª)</h3>
                            <button onclick="openModal('modal-invoice')" class="bg-green-100 text-green-700 px-3 py-1 rounded text-xs font-bold"><i class="fas fa-plus"></i> Ø¥ØµØ¯Ø§Ø± ÙØ§ØªÙˆØ±Ø©</button>
                        </div>
                        <div class="overflow-x-auto"><table class="w-full text-sm text-right"><tbody id="invoices-table" class="divide-y divide-slate-100 dark:divide-slate-700"></tbody></table></div>
                    </div>
                    <div class="glass-card p-5">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="font-black text-red-600"><i class="fas fa-money-bill-wave"></i> Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª ÙˆØ§Ù„ØªÙƒØ§Ù„ÙŠÙ</h3>
                            <button onclick="openModal('modal-expense')" class="bg-red-100 text-red-700 px-3 py-1 rounded text-xs font-bold"><i class="fas fa-plus"></i> ØªØ³Ø¬ÙŠÙ„ Ù…ØµØ±ÙˆÙ</button>
                        </div>
                        <div class="overflow-x-auto"><table class="w-full text-sm text-right"><tbody id="expenses-table" class="divide-y divide-slate-100 dark:divide-slate-700"></tbody></table></div>
                    </div>
                </div>
            </div>

            <div id="view-collections" class="hidden-view space-y-4">
                <div class="glass-card p-6 border-t-4 border-yellow-500">
                    <h3 class="font-black text-lg mb-4 text-yellow-600"><i class="fas fa-clock"></i> Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…ØªØ£Ø®Ø±Ø© ÙˆØ§Ù„ØªØ­ØµÙŠÙ„</h3>
                    <div id="collections-list" class="space-y-2"></div>
                </div>
            </div>

            <div id="view-reports" class="hidden-view">
                <div class="glass-card p-8 text-center"><i class="fas fa-cogs text-5xl text-slate-300 mb-4"></i><h3 class="font-bold">Ø³ÙŠØªÙ… Ø¨Ø±Ù…Ø¬Ø© ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± (PDF/Excel) ÙÙŠ Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©</h3></div>
            </div>

        </div>
    </main>

    <div id="modal-client" class="fixed inset-0 z-50 hidden bg-black/60 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-800 w-full max-w-lg rounded-2xl shadow-2xl p-6 border border-slate-200">
            <h3 class="text-lg font-black mb-4">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</h3>
            <form id="form-client" onsubmit="saveClient(event)" class="space-y-4">
                <input type="hidden" id="c-id">
                <div><label class="text-[10px] font-bold text-slate-500">Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„/Ø§Ù„Ø´Ø±ÙƒØ©</label><input type="text" id="c-name" class="form-input" required></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-[10px] font-bold text-slate-500">Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„</label><input type="tel" id="c-phone" class="form-input" required></div>
                    <div><label class="text-[10px] font-bold text-slate-500">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label><input type="email" id="c-email" class="form-input"></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-[10px] font-bold text-slate-500">Ø§Ù„Ù†ÙˆØ¹</label><select id="c-type" class="form-input"><option value="Ø´Ø±ÙƒØ©">Ø´Ø±ÙƒØ©</option><option value="ÙØ±Ø¯">ÙØ±Ø¯</option></select></div>
                    <div><label class="text-[10px] font-bold text-slate-500">Ø§Ù„Ù…ØµØ¯Ø±</label><select id="c-source" class="form-input"><option>SEO</option><option>Social Media</option><option>Referral</option><option>Other</option></select></div>
                </div>
                <div><label class="text-[10px] font-bold text-slate-500">Ø§Ù„Ø­Ø§Ù„Ø©</label>
                    <select id="c-status" class="form-input"><option value="Lead">Ù…Ø­ØªÙ…Ù„ (Lead)</option><option value="Active">Ù†Ø´Ø· (Active)</option><option value="Old">Ø³Ø§Ø¨Ù‚ (Old)</option><option value="Blacklist">Ù‚Ø§Ø¦Ù…Ø© Ø³ÙˆØ¯Ø§Ø¡</option></select>
                </div>
                <div class="flex gap-2 mt-4">
                    <button type="submit" class="flex-1 bg-primary-600 text-white font-bold py-2 rounded-lg">Ø­ÙØ¸</button>
                    <button type="button" onclick="closeModal('modal-client')" class="bg-slate-200 text-slate-700 font-bold py-2 px-4 rounded-lg">Ø¥Ù„ØºØ§Ø¡</button>
                </div>
            </form>
        </div>
    </div>

    <div id="modal-project" class="fixed inset-0 z-50 hidden bg-black/60 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-800 w-full max-w-lg rounded-2xl p-6">
            <h3 class="text-lg font-black mb-4">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</h3>
            <form id="form-project" onsubmit="saveProject(event)" class="space-y-4">
                <input type="hidden" id="p-id">
                <div><label class="text-[10px] font-bold">Ø§Ù„Ø¹Ù…ÙŠÙ„</label><select id="p-client" class="form-input" required></select></div>
                <div><label class="text-[10px] font-bold">Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</label><input type="text" id="p-title" class="form-input" required></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-[10px] font-bold">Ù‚ÙŠÙ…Ø© Ø§Ù„ØªØ¹Ø§Ù‚Ø¯</label><input type="number" id="p-budget" class="form-input" required></div>
                    <div><label class="text-[10px] font-bold">Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</label><select id="p-status" class="form-input"><option value="Pending">Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</option><option value="Progress">Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</option><option value="Done">Ù…Ù†ØªÙ‡ÙŠ</option></select></div>
                </div>
                <div class="flex gap-2"><button type="submit" class="flex-1 bg-primary-600 text-white font-bold py-2 rounded-lg">Ø­ÙØ¸</button><button type="button" onclick="closeModal('modal-project')" class="bg-slate-200 font-bold py-2 px-4 rounded-lg">Ø¥Ù„ØºØ§Ø¡</button></div>
            </form>
        </div>
    </div>

    <div id="modal-expense" class="fixed inset-0 z-50 hidden bg-black/60 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-800 w-full max-w-md rounded-2xl p-6 border-t-4 border-red-500">
            <h3 class="text-lg font-black text-red-600 mb-4">ØªØ³Ø¬ÙŠÙ„ Ù…ØµØ±ÙˆÙ Ù„Ù…Ø´Ø±ÙˆØ¹</h3>
            <form id="form-expense" onsubmit="saveExpense(event)" class="space-y-4">
                <div><label class="text-[10px] font-bold">Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</label><select id="ex-project" class="form-input" required></select></div>
                <div><label class="text-[10px] font-bold">Ø§Ù„Ù…Ø¨Ù„Øº</label><input type="number" id="ex-amount" class="form-input" required></div>
                <div><label class="text-[10px] font-bold">Ø§Ù„ØªÙØ§ØµÙŠÙ„ / Ø§Ù„Ø¨ÙŠØ§Ù†</label><input type="text" id="ex-desc" class="form-input" required></div>
                <div class="flex gap-2"><button type="submit" class="flex-1 bg-red-600 text-white font-bold py-2 rounded-lg">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙ</button><button type="button" onclick="closeModal('modal-expense')" class="bg-slate-200 font-bold py-2 px-4 rounded-lg">Ø¥Ù„ØºØ§Ø¡</button></div>
            </form>
        </div>
    </div>

    <div id="modal-invoice" class="fixed inset-0 z-50 hidden bg-black/60 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-slate-800 w-full max-w-md rounded-2xl p-6 border-t-4 border-green-500">
            <h3 class="text-lg font-black text-green-600 mb-4">Ø¥ØµØ¯Ø§Ø± ÙØ§ØªÙˆØ±Ø©</h3>
            <form id="form-invoice" onsubmit="saveInvoice(event)" class="space-y-4">
                <div><label class="text-[10px] font-bold">Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</label><select id="inv-project" class="form-input" required></select></div>
                <div><label class="text-[10px] font-bold">Ù…Ø¨Ù„Øº Ø§Ù„ÙØ§ØªÙˆØ±Ø©</label><input type="number" id="inv-amount" class="form-input" required></div>
                <div><label class="text-[10px] font-bold">Ø§Ù„Ø­Ø§Ù„Ø©</label><select id="inv-status" class="form-input"><option value="Unpaid">ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹Ø© (Ø¢Ø¬Ù„)</option><option value="Paid">Ù…Ø¯ÙÙˆØ¹Ø© (ØªÙ… Ø§Ù„ØªØ­ØµÙŠÙ„)</option></select></div>
                <div class="flex gap-2"><button type="submit" class="flex-1 bg-green-600 text-white font-bold py-2 rounded-lg">Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</button><button type="button" onclick="closeModal('modal-invoice')" class="bg-slate-200 font-bold py-2 px-4 rounded-lg">Ø¥Ù„ØºØ§Ø¡</button></div>
            </form>
        </div>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyCXyuT529aGwiS5j_RPxW_zEeAtkYc7JlM", authDomain: "almaster-b8c18.firebaseapp.com", projectId: "almaster-b8c18", storageBucket: "almaster-b8c18.firebasestorage.app", messagingSenderId: "884142036232", appId: "1:884142036232:web:eeb6677d988565653a08bd" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        let currentUser = null, userProfile = null;
        let allClients = [], allProjects = [], allExpenses = [], allInvoices = [];

        // 1. Auth & Init
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                const doc = await db.collection('users').doc(user.email.toLowerCase()).get();
                if(doc.exists) {
                    userProfile = doc.data();
                    document.getElementById('sidebar-user-name').innerText = userProfile.name;
                    document.getElementById('sidebar-user-role').innerText = userProfile.role;
                    document.getElementById('sidebar-user-img').src = userProfile.photo || `https://ui-avatars.com/api/?background=0ea5e9&color=fff&name=${userProfile.name}`;
                    document.getElementById('loader').classList.add('hidden');
                    initDataListeners();
                }
            } else { window.location.href = 'index.html'; }
        });

        // 2. Navigation
        function switchView(viewName) {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById('nav-' + viewName).classList.add('active');
            document.querySelectorAll('main > div > div[id^="view-"]').forEach(el => el.classList.add('hidden-view'));
            document.getElementById('view-' + viewName).classList.remove('hidden-view');
        }
        function toggleDarkMode() { document.documentElement.classList.toggle('dark-mode'); }
        function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); document.querySelector(`#${id} form`).reset(); }

        // 3. Real-time Database Listeners
        function initDataListeners() {
            db.collection('clients').onSnapshot(snap => {
                allClients = snap.docs.map(d => ({id: d.id, ...d.data()}));
                renderKanban(); updateDropdowns(); calculateDashboard();
            });
            db.collection('projects').onSnapshot(snap => {
                allProjects = snap.docs.map(d => ({id: d.id, ...d.data()}));
                renderProjects(); updateDropdowns(); calculateDashboard();
            });
            db.collection('expenses').onSnapshot(snap => {
                allExpenses = snap.docs.map(d => ({id: d.id, ...d.data()}));
                renderFinancials(); calculateDashboard(); renderProjects(); // Recalculate profit
            });
            db.collection('invoices').onSnapshot(snap => {
                allInvoices = snap.docs.map(d => ({id: d.id, ...d.data()}));
                renderFinancials(); renderCollections();
            });
        }

        function generateCode(prefix) { return `${prefix}-${Math.floor(1000 + Math.random() * 9000)}`; }

        // 4. CRUD Clients
        async function saveClient(e) {
            e.preventDefault();
            const id = document.getElementById('c-id').value;
            const data = {
                clientCode: id ? undefined : generateCode('CUST'),
                name: document.getElementById('c-name').value,
                phone: document.getElementById('c-phone').value,
                email: document.getElementById('c-email').value,
                type: document.getElementById('c-type').value,
                source: document.getElementById('c-source').value,
                status: document.getElementById('c-status').value,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                addedBy: userProfile.name
            };
            if(id) await db.collection('clients').doc(id).update(data);
            else await db.collection('clients').add(data);
            closeModal('modal-client');
        }

        function renderKanban() {
            const cols = { 'Lead': 'kb-leads', 'Active': 'kb-active', 'Old': 'kb-old', 'Blacklist': 'kb-blacklist' };
            Object.values(cols).forEach(id => document.getElementById(id).innerHTML = '');
            
            allClients.forEach(c => {
                const targetCol = document.getElementById(cols[c.status]);
                if(targetCol) {
                    targetCol.innerHTML += `
                        <div class="kanban-card cursor-pointer" onclick="editClient('${c.id}')">
                            <div class="flex justify-between mb-1"><span class="font-bold text-sm">${c.name}</span><span class="text-[9px] text-slate-400 font-mono">${c.clientCode}</span></div>
                            <p class="text-xs text-slate-500 mb-2"><i class="fas fa-phone mr-1"></i> ${c.phone}</p>
                            <span class="bg-slate-100 text-slate-500 text-[10px] px-2 py-1 rounded">${c.type} | ${c.source}</span>
                        </div>
                    `;
                }
            });
        }

        function editClient(id) {
            const c = allClients.find(x => x.id === id);
            if(!c) return;
            document.getElementById('c-id').value = c.id;
            document.getElementById('c-name').value = c.name;
            document.getElementById('c-phone').value = c.phone;
            document.getElementById('c-email').value = c.email;
            document.getElementById('c-type').value = c.type;
            document.getElementById('c-source').value = c.source;
            document.getElementById('c-status').value = c.status;
            openModal('modal-client');
        }

        // 5. CRUD Projects
        function updateDropdowns() {
            const cDrop = document.getElementById('p-client');
            cDrop.innerHTML = '<option disabled selected>Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…ÙŠÙ„...</option>';
            allClients.filter(c => c.status === 'Active').forEach(c => cDrop.innerHTML += `<option value="${c.id}">${c.name}</option>`);

            const pDrops = [document.getElementById('ex-project'), document.getElementById('inv-project')];
            pDrops.forEach(drop => {
                drop.innerHTML = '<option disabled selected>Ø§Ø®ØªØ± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹...</option>';
                allProjects.forEach(p => drop.innerHTML += `<option value="${p.id}">${p.title}</option>`);
            });
        }

        async function saveProject(e) {
            e.preventDefault();
            const id = document.getElementById('p-id').value;
            const clientId = document.getElementById('p-client').value;
            const clientName = allClients.find(c => c.id === clientId)?.name || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
            
            const data = {
                projectCode: id ? undefined : generateCode('PROJ'),
                clientId: clientId,
                clientName: clientName,
                title: document.getElementById('p-title').value,
                budget: Number(document.getElementById('p-budget').value),
                status: document.getElementById('p-status').value,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };
            if(id) await db.collection('projects').doc(id).update(data);
            else await db.collection('projects').add(data);
            closeModal('modal-project');
        }

        function renderProjects() {
            const list = document.getElementById('projects-list');
            list.innerHTML = '';
            
            allProjects.forEach(p => {
                // Ø­Ø³Ø§Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
                const projExpenses = allExpenses.filter(e => e.projectId === p.id).reduce((sum, e) => sum + e.amount, 0);
                const profit = p.budget - projExpenses;
                const profitColor = profit >= 0 ? 'text-green-600' : 'text-red-600';

                list.innerHTML += `
                    <div class="glass-card p-5 flex justify-between items-center border-r-4 ${p.status==='Done'?'border-green-500':'border-primary-500'}">
                        <div class="w-1/3">
                            <p class="text-[10px] text-slate-400 font-mono">${p.projectCode}</p>
                            <h4 class="font-black text-lg">${p.title}</h4>
                            <p class="text-xs text-primary-600 font-bold"><i class="fas fa-user mr-1"></i> ${p.clientName}</p>
                        </div>
                        <div class="w-1/3 text-center">
                            <span class="px-3 py-1 bg-slate-100 rounded-full text-xs font-bold">${p.status}</span>
                        </div>
                        <div class="w-1/3 bg-slate-50 dark:bg-slate-800 p-3 rounded-lg text-left text-sm">
                            <div class="flex justify-between mb-1"><span class="text-slate-500">Ø§Ù„ØªØ¹Ø§Ù‚Ø¯:</span><span class="font-bold">${p.budget.toLocaleString()}</span></div>
                            <div class="flex justify-between mb-1"><span class="text-slate-500">Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª:</span><span class="font-bold text-red-500">${projExpenses.toLocaleString()}</span></div>
                            <div class="flex justify-between mt-2 pt-2 border-t border-slate-200"><span class="font-black">Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„ÙØ¹Ù„ÙŠ:</span><span class="font-black ${profitColor}">${profit.toLocaleString()}</span></div>
                        </div>
                    </div>
                `;
            });
        }

        // 6. Expenses & Invoices
        async function saveExpense(e) {
            e.preventDefault();
            const projectId = document.getElementById('ex-project').value;
            const projectName = allProjects.find(p => p.id === projectId)?.title || '';
            await db.collection('expenses').add({
                projectId, projectName,
                amount: Number(document.getElementById('ex-amount').value),
                desc: document.getElementById('ex-desc').value,
                addedBy: userProfile.name,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            closeModal('modal-expense');
        }

        async function saveInvoice(e) {
            e.preventDefault();
            const projectId = document.getElementById('inv-project').value;
            const projectName = allProjects.find(p => p.id === projectId)?.title || '';
            await db.collection('invoices').add({
                invoiceCode: generateCode('INV'),
                projectId, projectName,
                amount: Number(document.getElementById('inv-amount').value),
                status: document.getElementById('inv-status').value,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            closeModal('modal-invoice');
        }

        function renderFinancials() {
            const expTable = document.getElementById('expenses-table');
            expTable.innerHTML = '';
            allExpenses.forEach(e => {
                const time = e.timestamp ? moment(e.timestamp.toDate()).format('YYYY-MM-DD') : '';
                expTable.innerHTML += `<tr><td class="p-3 text-xs">${time}</td><td class="p-3 font-bold">${e.projectName}</td><td class="p-3">${e.desc}</td><td class="p-3 font-black text-red-500">${e.amount.toLocaleString()}</td></tr>`;
            });

            const invTable = document.getElementById('invoices-table');
            invTable.innerHTML = '';
            allInvoices.forEach(i => {
                const time = i.timestamp ? moment(i.timestamp.toDate()).format('YYYY-MM-DD') : '';
                const badge = i.status === 'Paid' ? '<span class="text-green-500 font-bold">Ù…Ø¯ÙÙˆØ¹Ø©</span>' : '<span class="text-yellow-600 font-bold">ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹Ø©</span>';
                invTable.innerHTML += `<tr><td class="p-3 text-xs">${time}</td><td class="p-3 font-mono">${i.invoiceCode}</td><td class="p-3 font-bold text-primary-600">${i.projectName}</td><td class="p-3 font-black">${i.amount.toLocaleString()}</td><td class="p-3">${badge}</td></tr>`;
            });
        }

        function renderCollections() {
            const list = document.getElementById('collections-list');
            list.innerHTML = '';
            const unpaid = allInvoices.filter(i => i.status === 'Unpaid');
            if(unpaid.length === 0) { list.innerHTML = '<p class="text-slate-500 font-bold text-center py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ± Ù…ØªØ£Ø®Ø±Ø© ğŸ‰</p>'; return; }
            
            unpaid.forEach(i => {
                list.innerHTML += `
                    <div class="flex justify-between items-center bg-white p-3 rounded-lg border border-yellow-200 shadow-sm">
                        <div><h4 class="font-bold text-sm">${i.projectName}</h4><p class="text-[10px] text-slate-400">ÙØ§ØªÙˆØ±Ø© Ø±Ù‚Ù…: ${i.invoiceCode}</p></div>
                        <div class="text-left"><p class="font-black text-red-600">${i.amount.toLocaleString()} Ø±.Ø³</p><button class="text-[10px] bg-yellow-100 text-yellow-700 px-2 py-1 rounded font-bold mt-1">ØªØ°ÙƒÙŠØ± Ø¨Ø§Ù„Ø¯ÙØ¹</button></div>
                    </div>
                `;
            });
        }

        // 7. Dashboard Calculation
        function calculateDashboard() {
            const openProjects = allProjects.filter(p => p.status !== 'Done').length;
            document.getElementById('dash-projects').innerText = openProjects;

            const totalRevenue = allProjects.reduce((sum, p) => sum + (Number(p.budget) || 0), 0);
            const totalExpenses = allExpenses.reduce((sum, e) => sum + (Number(e.amount) || 0), 0);
            const totalProfit = totalRevenue - totalExpenses;

            document.getElementById('dash-revenue').innerHTML = `${totalRevenue.toLocaleString()} <span class="text-sm">Ø±.Ø³</span>`;
            document.getElementById('dash-expenses').innerHTML = `${totalExpenses.toLocaleString()} <span class="text-sm">Ø±.Ø³</span>`;
            document.getElementById('dash-profit').innerHTML = `${totalProfit.toLocaleString()} <span class="text-sm">Ø±.Ø³</span>`;
        }
    </script>
</body>
</html>
